<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CLASSGUARD - B·∫£ng ƒëi·ªÅu khi·ªÉn</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #667eea;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
        }
        body {
            background: #f8fafc;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .sidebar {
            background: white;
            min-height: 100vh;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            position: fixed;
            width: 250px;
        }
        .main-content {
            margin-left: 250px;
            padding: 20px;
        }
        .nav-link {
            color: #4a5568;
            padding: 12px 20px;
            margin: 5px 0;
            border-radius: 10px;
            transition: all 0.3s;
        }
        .nav-link:hover, .nav-link.active {
            background: var(--primary);
            color: white;
        }
        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            transition: transform 0.3s;
            margin-bottom: 20px;
        }
        .card:hover {
            transform: translateY(-5px);
        }
        .sensor-card {
            text-align: center;
            padding: 20px;
        }
        .sensor-icon {
            font-size: 2.5rem;
            margin-bottom: 15px;
        }
        .value {
            font-size: 2rem;
            font-weight: bold;
            margin: 10px 0;
        }
        .unit {
            color: #718096;
            font-size: 0.9rem;
        }
        .status-good { color: var(--success); }
        .status-warning { color: var(--warning); }
        .status-danger { color: var(--danger); }
        .control-btn {
            width: 100%;
            padding: 15px;
            font-size: 1.1rem;
            margin: 5px 0;
        }
        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                position: relative;
                min-height: auto;
            }
            .main-content {
                margin-left: 0;
            }
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="p-4">
            <div class="text-center mb-4">
                <i class="fas fa-school fa-3x text-primary"></i>
                <h3 class="mt-2">CLASSGUARD</h3>
                <small class="text-muted">L·ªõp h·ªçc th√¥ng minh</small>
            </div>
            
            <div class="user-info text-center mb-4 p-3 bg-light rounded">
                <i class="fas fa-user-circle fa-2x"></i>
                <h5 class="mt-2">{{ username }}</h5>
                <span class="badge bg-{{ 'primary' if role == 'admin' else 'secondary' }}">
                    {{ 'Qu·∫£n tr·ªã vi√™n' if role == 'admin' else 'Ng∆∞·ªùi xem' }}
                </span>
            </div>
            
            <nav class="nav flex-column">
                <a class="nav-link active" href="/dashboard">
                    <i class="fas fa-tachometer-alt"></i> B·∫£ng ƒëi·ªÅu khi·ªÉn
                </a>
                <a class="nav-link" href="/data">
                    <i class="fas fa-database"></i> D·ªØ li·ªáu
                </a>
                {% if role == 'admin' %}
                <a class="nav-link" href="/settings">
                    <i class="fas fa-cog"></i> C√†i ƒë·∫∑t
                </a>
                {% endif %}
                <a class="nav-link text-danger" href="/logout">
                    <i class="fas fa-sign-out-alt"></i> ƒêƒÉng xu·∫•t
                </a>
            </nav>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2><i class="fas fa-tachometer-alt"></i> B·∫£ng ƒëi·ªÅu khi·ªÉn</h2>
            <div class="text-end">
                <span id="current-time" class="badge bg-primary p-2"></span>
                <span class="text-muted ms-2">C·∫≠p nh·∫≠t: <span id="last-update">--:--:--</span></span>
            </div>
        </div>

        <!-- Th√¥ng b√°o -->
        <div id="alert-container"></div>

        <!-- Cards c·∫£m bi·∫øn -->
        <div class="row">
            <!-- Nhi·ªát ƒë·ªô -->
            <div class="col-md-3">
                <div class="card sensor-card">
                    <div class="sensor-icon status-{{ 'danger' if data.nhiet_do > 30 else 'warning' if data.nhiet_do > 28 else 'good' }}">
                        <i class="fas fa-thermometer-half"></i>
                    </div>
                    <h5>Nhi·ªát ƒë·ªô</h5>
                    <div class="value" id="temp-value">{{ data.nhiet_do }}</div>
                    <div class="unit">¬∞C</div>
                    <div class="mt-2">
                        <span class="badge bg-{{ 'danger' if data.nhiet_do > 30 else 'warning' if data.nhiet_do > 28 else 'success' }}">
                            {{ 'N√≥ng' if data.nhiet_do > 30 else '·∫§m' if data.nhiet_do > 28 else 'T·ªët' }}
                        </span>
                    </div>
                </div>
            </div>

            <!-- ƒê·ªô ·∫©m -->
            <div class="col-md-3">
                <div class="card sensor-card">
                    <div class="sensor-icon status-{{ 'warning' if data.do_am < 40 or data.do_am > 70 else 'good' }}">
                        <i class="fas fa-tint"></i>
                    </div>
                    <h5>ƒê·ªô ·∫©m</h5>
                    <div class="value" id="hum-value">{{ data.do_am }}</div>
                    <div class="unit">%</div>
                    <div class="mt-2">
                        <span class="badge bg-{{ 'warning' if data.do_am < 40 or data.do_am > 70 else 'success' }}">
                            {{ 'Kh√¥' if data.do_am < 40 else '·∫®m' if data.do_am > 70 else 'T·ªët' }}
                        </span>
                    </div>
                </div>
            </div>

            <!-- √Ånh s√°ng -->
            <div class="col-md-3">
                <div class="card sensor-card">
                    <div class="sensor-icon status-{{ 'danger' if data.anh_sang < 200 else 'warning' if data.anh_sang < 300 else 'good' }}">
                        <i class="fas fa-sun"></i>
                    </div>
                    <h5>√Ånh s√°ng</h5>
                    <div class="value" id="light-value">{{ data.anh_sang }}</div>
                    <div class="unit">Lux</div>
                    <div class="mt-2">
                        <span class="badge bg-{{ 'danger' if data.anh_sang < 200 else 'warning' if data.anh_sang < 300 else 'success' }}">
                            {{ 'T·ªëi' if data.anh_sang < 200 else 'V·ª´a' if data.anh_sang < 300 else 'S√°ng' }}
                        </span>
                    </div>
                </div>
            </div>

            <!-- Ch·∫•t l∆∞·ª£ng kh√¥ng kh√≠ -->
            <div class="col-md-3">
                <div class="card sensor-card">
                    <div class="sensor-icon status-{{ 'danger' if data.chat_luong_kk > 800 else 'warning' if data.chat_luong_kk > 400 else 'good' }}">
                        <i class="fas fa-wind"></i>
                    </div>
                    <h5>Ch·∫•t l∆∞·ª£ng KK</h5>
                    <div class="value" id="air-value">{{ data.chat_luong_kk }}</div>
                    <div class="unit">PPM</div>
                    <div class="mt-2">
                        <span class="badge bg-{{ 'danger' if data.chat_luong_kk > 800 else 'warning' if data.chat_luong_kk > 400 else 'success' }}">
                            {{ '√î nhi·ªÖm' if data.chat_luong_kk > 800 else 'Trung b√¨nh' if data.chat_luong_kk > 400 else 'T·ªët' }}
                        </span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bi·ªÉu ƒë·ªì v√† ƒëi·ªÅu khi·ªÉn -->
        <div class="row mt-4">
            <!-- Bi·ªÉu ƒë·ªì -->
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-chart-line"></i> Bi·ªÉu ƒë·ªì theo th·ªùi gian</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="sensorChart" height="200"></canvas>
                    </div>
                </div>
            </div>

            <!-- ƒêi·ªÅu khi·ªÉn -->
            {% if role == 'admin' %}
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-gamepad"></i> ƒêi·ªÅu khi·ªÉn thi·∫øt b·ªã</h5>
                    </div>
                    <div class="card-body">
                        <!-- Qu·∫°t -->
                        <div class="mb-4">
                            <h6><i class="fas fa-fan"></i> Qu·∫°t</h6>
                            <div class="btn-group w-100" role="group">
                                <button class="btn btn-success control-btn" onclick="controlDevice('quat', 'on')">
                                    <i class="fas fa-play"></i> B·∫¨T
                                </button>
                                <button class="btn btn-danger control-btn" onclick="controlDevice('quat', 'off')">
                                    <i class="fas fa-stop"></i> T·∫ÆT
                                </button>
                            </div>
                            <div class="mt-2 text-center">
                                <span class="badge bg-{{ 'success' if data.quat == 'ON' else 'secondary' }}">
                                    Tr·∫°ng th√°i: {{ data.quat }}
                                </span>
                            </div>
                        </div>

                        <!-- ƒê√®n -->
                        <div class="mb-4">
                            <h6><i class="fas fa-lightbulb"></i> ƒê√®n</h6>
                            <div class="btn-group w-100" role="group">
                                <button class="btn btn-success control-btn" onclick="controlDevice('den', 'on')">
                                    <i class="fas fa-lightbulb"></i> B·∫¨T
                                </button>
                                <button class="btn btn-danger control-btn" onclick="controlDevice('den', 'off')">
                                    <i class="fas fa-lightbulb"></i> T·∫ÆT
                                </button>
                            </div>
                            <div class="mt-2 text-center">
                                <span class="badge bg-{{ 'success' if data.den == 'ON' else 'secondary' }}">
                                    Tr·∫°ng th√°i: {{ data.den }}
                                </span>
                            </div>
                        </div>

                        <!-- Ch·∫ø ƒë·ªô t·ª± ƒë·ªông -->
                        <div class="mb-4">
                            <h6><i class="fas fa-robot"></i> Ch·∫ø ƒë·ªô t·ª± ƒë·ªông</h6>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="auto-mode" checked>
                                <label class="form-check-label" for="auto-mode">T·ª± ƒë·ªông ƒëi·ªÅu ch·ªânh</label>
                            </div>
                            <small class="text-muted">H·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông b·∫≠t/t·∫Øt thi·∫øt b·ªã d·ª±a tr√™n ng∆∞·ª°ng</small>
                        </div>

                        <!-- Xu·∫•t b√°o c√°o -->
                        <div>
                            <a href="/export_pdf" class="btn btn-primary w-100">
                                <i class="fas fa-file-pdf"></i> Xu·∫•t b√°o c√°o PDF
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Nh·∫≠n x√©t ti·∫øt h·ªçc -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-chalkboard-teacher"></i> ƒê√°nh gi√° m√¥i tr∆∞·ªùng h·ªçc t·∫≠p</h5>
                    </div>
                    <div class="card-body">
                        <div class="row" id="class-evaluation">
                            <!-- S·∫Ω ƒë∆∞·ª£c c·∫≠p nh·∫≠t b·∫±ng JavaScript -->
                            <div class="col-md-3 text-center">
                                <i class="fas fa-thermometer-three-quarters fa-2x text-warning"></i>
                                <h6 class="mt-2">Nhi·ªát ƒë·ªô</h6>
                                <span id="eval-temp" class="badge bg-warning">ƒêang ki·ªÉm tra...</span>
                            </div>
                            <div class="col-md-3 text-center">
                                <i class="fas fa-volume-up fa-2x text-info"></i>
                                <h6 class="mt-2">ƒê·ªô ·ªìn</h6>
                                <span id="eval-noise" class="badge bg-info">ƒêang ki·ªÉm tra...</span>
                            </div>
                            <div class="col-md-3 text-center">
                                <i class="fas fa-air-freshener fa-2x text-success"></i>
                                <h6 class="mt-2">Kh√¥ng kh√≠</h6>
                                <span id="eval-air" class="badge bg-success">ƒêang ki·ªÉm tra...</span>
                            </div>
                            <div class="col-md-3 text-center">
                                <i class="fas fa-star fa-2x text-primary"></i>
                                <h6 class="mt-2">T·ªïng th·ªÉ</h6>
                                <span id="eval-overall" class="badge bg-primary">ƒêang ƒë√°nh gi√°...</span>
                            </div>
                        </div>
                        <div class="mt-3" id="recommendations">
                            <!-- Khuy·∫øn ngh·ªã s·∫Ω hi·ªán ·ªü ƒë√¢y -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <footer class="mt-4 text-center text-muted">
            <p>H·ªá th·ªëng CLASSGUARD - Gi√°m s√°t m√¥i tr∆∞·ªùng l·ªõp h·ªçc th√¥ng minh</p>
            <p>D·ªØ li·ªáu c·∫≠p nh·∫≠t 5 gi√¢y/l·∫ßn | Phi√™n b·∫£n 1.0</p>
        </footer>
    </div>

    <!-- JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Bi·ªÉu ƒë·ªì
        const ctx = document.getElementById('sensorChart').getContext('2d');
        const chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [
                    {
                        label: 'Nhi·ªát ƒë·ªô (¬∞C)',
                        data: [],
                        borderColor: '#ef4444',
                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                        tension: 0.4
                    },
                    {
                        label: 'ƒê·ªô ·∫©m (%)',
                        data: [],
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.4
                    }
                ]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: false
                    }
                }
            }
        });

        // C·∫≠p nh·∫≠t th·ªùi gian
        function updateTime() {
            const now = new Date();
            document.getElementById('current-time').textContent = 
                now.toLocaleTimeString('vi-VN');
        }
        setInterval(updateTime, 1000);
        updateTime();

        // L·∫•y d·ªØ li·ªáu c·∫£m bi·∫øn
        function fetchSensorData() {
            fetch('/get_sensor_data')
                .then(response => response.json())
                .then(data => {
                    // C·∫≠p nh·∫≠t gi√° tr·ªã
                    document.getElementById('temp-value').textContent = data.nhiet_do.toFixed(1);
                    document.getElementById('hum-value').textContent = data.do_am.toFixed(1);
                    document.getElementById('light-value').textContent = Math.round(data.anh_sang);
                    document.getElementById('air-value').textContent = Math.round(data.chat_luong_kk);
                    document.getElementById('last-update').textContent = data.timestamp || '--:--:--';

                    // C·∫≠p nh·∫≠t bi·ªÉu ƒë·ªì
                    const now = new Date().toLocaleTimeString('vi-VN', {hour12: false});
                    chart.data.labels.push(now);
                    chart.data.datasets[0].data.push(data.nhiet_do);
                    chart.data.datasets[1].data.push(data.do_am);
                    
                    if (chart.data.labels.length > 20) {
                        chart.data.labels.shift();
                        chart.data.datasets[0].data.shift();
                        chart.data.datasets[1].data.shift();
                    }
                    chart.update();

                    // ƒê√°nh gi√° ti·∫øt h·ªçc
                    evaluateClass(data);

                    // Ki·ªÉm tra c·∫£nh b√°o
                    checkAlerts(data);
                })
                .catch(error => console.error('L·ªói:', error));
        }

        // ƒê√°nh gi√° m√¥i tr∆∞·ªùng h·ªçc t·∫≠p
        function evaluateClass(data) {
            // ƒê√°nh gi√° nhi·ªát ƒë·ªô
            let tempEval, tempColor;
            if (data.nhiet_do < 20) {
                tempEval = 'L·∫°nh';
                tempColor = 'info';
            } else if (data.nhiet_do <= 28) {
                tempEval = 'L√Ω t∆∞·ªüng';
                tempColor = 'success';
            } else if (data.nhiet_do <= 32) {
                tempEval = 'H∆°i n√≥ng';
                tempColor = 'warning';
            } else {
                tempEval = 'Qu√° n√≥ng';
                tempColor = 'danger';
            }
            document.getElementById('eval-temp').textContent = tempEval;
            document.getElementById('eval-temp').className = `badge bg-${tempColor}`;

            // ƒê√°nh gi√° ƒë·ªô ·ªìn
            let noiseEval, noiseColor;
            if (data.do_on < 50) {
                noiseEval = 'Y√™n tƒ©nh';
                noiseColor = 'success';
            } else if (data.do_on <= 70) {
                noiseEval = 'B√¨nh th∆∞·ªùng';
                noiseColor = 'warning';
            } else {
                noiseEval = '·ªín √†o';
                noiseColor = 'danger';
            }
            document.getElementById('eval-noise').textContent = noiseEval;
            document.getElementById('eval-noise').className = `badge bg-${noiseColor}`;

            // ƒê√°nh gi√° kh√¥ng kh√≠
            let airEval, airColor;
            if (data.chat_luong_kk < 400) {
                airEval = 'Trong l√†nh';
                airColor = 'success';
            } else if (data.chat_luong_kk <= 800) {
                airEval = 'Trung b√¨nh';
                airColor = 'warning';
            } else {
                airEval = '√î nhi·ªÖm';
                airColor = 'danger';
            }
            document.getElementById('eval-air').textContent = airEval;
            document.getElementById('eval-air').className = `badge bg-${airColor}`;

            // ƒê√°nh gi√° t·ªïng th·ªÉ
            let overallScore = 0;
            if (data.nhiet_do >= 20 && data.nhiet_do <= 28) overallScore += 2;
            else if (data.nhiet_do > 28 && data.nhiet_do <= 32) overallScore += 1;
            
            if (data.do_on < 70) overallScore += 2;
            else overallScore += 1;
            
            if (data.chat_luong_kk < 800) overallScore += 2;
            else overallScore += 1;
            
            let overallEval, overallColor;
            if (overallScore >= 5) {
                overallEval = 'T·ªët';
                overallColor = 'success';
            } else if (overallScore >= 3) {
                overallEval = 'Kh√°';
                overallColor = 'warning';
            } else {
                overallEval = 'C·∫ßn c·∫£i thi·ªán';
                overallColor = 'danger';
            }
            document.getElementById('eval-overall').textContent = overallEval;
            document.getElementById('eval-overall').className = `badge bg-${overallColor}`;

            // Khuy·∫øn ngh·ªã
            let recommendations = [];
            if (data.nhiet_do > 28) {
                recommendations.push('Nhi·ªát ƒë·ªô cao: N√™n b·∫≠t qu·∫°t ho·∫∑c ƒëi·ªÅu h√≤a');
            }
            if (data.do_on > 70) {
                recommendations.push('L·ªõp h·ªçc ·ªìn: C·∫ßn gi·∫£m ti·∫øng ·ªìn');
            }
            if (data.chat_luong_kk > 800) {
                recommendations.push('Ch·∫•t l∆∞·ª£ng kh√¥ng kh√≠ k√©m: N√™n m·ªü c·ª≠a th√¥ng tho√°ng');
            }
            if (data.anh_sang < 300) {
                recommendations.push('√Ånh s√°ng y·∫øu: N√™n b·∫≠t ƒë√®n');
            }
            
            const recHtml = recommendations.length > 0 ? 
                '<strong>Khuy·∫øn ngh·ªã:</strong><br>' + recommendations.join('<br>') :
                '<div class="text-success"><i class="fas fa-check-circle"></i> M√¥i tr∆∞·ªùng h·ªçc t·∫≠p t·ªët!</div>';
            
            document.getElementById('recommendations').innerHTML = recHtml;
        }

        // Ki·ªÉm tra c·∫£nh b√°o
        function checkAlerts(data) {
            const alerts = [];
            if (data.nhiet_do > 32) {
                alerts.push({
                    type: 'danger',
                    message: '‚ö†Ô∏è Nhi·ªát ƒë·ªô qu√° cao! C·∫ßn l√†m m√°t ngay.'
                });
            }
            if (data.do_on > 80) {
                alerts.push({
                    type: 'warning',
                    message: 'üîä L·ªõp h·ªçc qu√° ·ªìn! C·∫ßn gi·ªØ tr·∫≠t t·ª±.'
                });
            }
            if (data.chat_luong_kk > 1000) {
                alerts.push({
                    type: 'danger',
                    message: 'üí® Ch·∫•t l∆∞·ª£ng kh√¥ng kh√≠ nguy hi·ªÉm! M·ªü c·ª≠a ngay.'
                });
            }
            
            showAlerts(alerts);
        }

        // Hi·ªÉn th·ªã c·∫£nh b√°o
        function showAlerts(alerts) {
            const container = document.getElementById('alert-container');
            container.innerHTML = '';
            
            alerts.forEach(alert => {
                const alertDiv = document.createElement('div');
                alertDiv.className = `alert alert-${alert.type} alert-dismissible fade show`;
                alertDiv.innerHTML = `
                    ${alert.message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                container.appendChild(alertDiv);
            });
        }

        // ƒêi·ªÅu khi·ªÉn thi·∫øt b·ªã
        function controlDevice(device, action) {
            if ("{{ role }}" !== 'admin') {
                alert('B·∫°n kh√¥ng c√≥ quy·ªÅn ƒëi·ªÅu khi·ªÉn!');
                return;
            }
            
            fetch('/control', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    device: device,
                    action: action
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast('Th√†nh c√¥ng', `ƒê√£ ${action === 'on' ? 'b·∫≠t' : 't·∫Øt'} ${device}`, 'success');
                } else {
                    showToast('L·ªói', data.error || 'C√≥ l·ªói x·∫£y ra', 'danger');
                }
            });
        }

        // Hi·ªÉn th·ªã th√¥ng b√°o nh·ªè
        function showToast(title, message, type) {
            const toast = document.createElement('div');
            toast.className = `toast align-items-center text-white bg-${type} border-0`;
            toast.setAttribute('role', 'alert');
            toast.innerHTML = `
                <div class="d-flex">
                    <div class="toast-body">
                        <strong>${title}:</strong> ${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            `;
            
            const container = document.createElement('div');
            container.className = 'toast-container position-fixed bottom-0 end-0 p-3';
            container.appendChild(toast);
            document.body.appendChild(container);
            
            const bsToast = new bootstrap.Toast(toast);
            bsToast.show();
            
            toast.addEventListener('hidden.bs.toast', function () {
                container.remove();
            });
        }

        // T·ª± ƒë·ªông c·∫≠p nh·∫≠t d·ªØ li·ªáu m·ªói 5 gi√¢y
        setInterval(fetchSensorData, 5000);
        fetchSensorData(); // L·∫•y d·ªØ li·ªáu ngay khi t·∫£i trang
    </script>
</body>
</html>
