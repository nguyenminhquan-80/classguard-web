<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CLASSGUARD - B·∫£ng ƒëi·ªÅu khi·ªÉn</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>    
    <style>
        :root {
            --primary: #4361ee;
            --secondary: #3a0ca3;
            --success: #28a745;
            --warning: #ffc107;
            --danger: #dc3545;
            --info: #17a2b8;
            --light: #f8f9fa;
            --dark: #343a40;
        }
        
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #e4e8f0 100%);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100vh;
        }
        
        /* ====== FIX CHART CONTAINERS ====== */
        .chart-container {
            height: 300px !important;
            min-height: 300px !important;
            max-height: 300px !important;
            position: relative;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .chart-container canvas {
            width: 100% !important;
            height: 300px !important;
            max-height: 300px !important;
        }

        /* Hi·ªáu ·ª©ng c·ª≠a */
        .door-open {
            color: #28a745 !important;
            animation: doorOpen 0.5s ease;
        }
        
        .door-closed {
            color: #dc3545 !important;
            animation: doorClose 0.5s ease;
        }
        
        @keyframes doorOpen {
            0% { transform: rotateY(0deg); }
            100% { transform: rotateY(-20deg); }
        }
        
        @keyframes doorClose {
            0% { transform: rotateY(-20deg); }
            100% { transform: rotateY(0deg); }
        }

        /* Animation cho qu·∫°t */
        .fa-fan.fa-spin {
            animation: fa-spin 1.5s infinite linear;
        }

        /* Animation cho chu√¥ng c·∫£nh b√°o */
        @keyframes bell-shake {
            0% { transform: rotate(0deg); }
            25% { transform: rotate(-15deg); }
            75% { transform: rotate(15deg); }
            100% { transform: rotate(0deg); }
        }

        .fa-bell.fa-shake {
            animation: bell-shake 0.5s infinite;
        }

        /* Connection status */
        .connection-badge {
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9rem;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            transition: all 0.3s ease;
        }

        .connected {
            background: rgba(40, 167, 69, 0.15);
            color: var(--success);
            border: 2px solid var(--success);
        }

        .disconnected {
            background: rgba(220, 53, 69, 0.15);
            color: var(--danger);
            border: 2px solid var(--danger);
        }

        .connecting {
            background: rgba(255, 193, 7, 0.15);
            color: var(--warning);
            border: 2px solid var(--warning);
        }

        /* Toast notifications */
        .toast-container {
            z-index: 9999;
        }

        /* Real-time indicator */
        .real-time-indicator {
            position: relative;
            padding-left: 20px;
        }
        
        .real-time-indicator::before {
            content: '';
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: #28a745;
            animation: pulse 2s infinite;
        }
        
        .real-time-indicator.offline::before {
            background-color: #dc3545;
            animation: none;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(40, 167, 69, 0); }
            100% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0); }
        }

        /* Responsive */
        @media (max-width: 992px) {
            .chart-container {
                height: 260px !important;
            }
            
            .chart-container canvas {
                height: 260px !important;
            }
        }

        @media (max-width: 768px) {
            .chart-container {
                height: 240px !important;
            }
            
            .chart-container canvas {
                height: 240px !important;
            }
        }

        /* Main Container */
        .main-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        /* Header */
        .dashboard-header {
            background: white;
            border-radius: 15px;
            padding: 15px 25px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            margin-bottom: 25px;
            border-left: 5px solid var(--primary);
        }
        
        .logo-area {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .logo-icon {
            font-size: 2.2rem;
            color: var(--primary);
            background: linear-gradient(135deg, #4361ee 0%, #3a0ca3 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .logo-text {
            font-size: 1.8rem;
            font-weight: 800;
            color: var(--primary);
            margin: 0;
        }
        
        .logo-subtext {
            font-size: 0.85rem;
            color: #6c757d;
            margin: 0;
        }
        
        /* Navigation */
        .nav-menu {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .nav-btn {
            padding: 10px 20px;
            border-radius: 10px;
            font-weight: 600;
            font-size: 0.95rem;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
        }
        
        .nav-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .nav-btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            border: none;
        }
        
        .nav-btn-outline {
            background: white;
            color: var(--primary);
            border: 2px solid var(--primary);
        }
        
        .nav-btn-success {
            background: var(--success);
            color: white;
            border: none;
        }
        
        .nav-btn-warning {
            background: var(--warning);
            color: var(--dark);
            border: none;
        }
        
        /* User Info */
        .user-info {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 20px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }
        
        .user-avatar {
            width: 45px;
            height: 45px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }
        
        .user-details {
            flex-grow: 1;
        }
        
        .user-name {
            font-weight: 600;
            margin: 0;
            font-size: 1.1rem;
        }
        
        .user-role {
            font-size: 0.85rem;
            opacity: 0.9;
            margin: 2px 0 0 0;
        }
        
        .login-time {
            font-size: 0.75rem;
            opacity: 0.8;
            margin: 3px 0 0 0;
        }
        
        /* Time Display */
        .time-display {
            text-align: center;
            padding: 10px 15px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
        }
        
        .current-time {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--primary);
            margin: 0;
        }
        
        .time-label {
            font-size: 0.85rem;
            color: #6c757d;
            margin: 0;
        }
        
        /* Sensor Cards */
        .sensor-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .sensor-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            border: 3px solid transparent;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .sensor-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: currentColor;
            opacity: 0.3;
        }
        
        .sensor-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.12);
        }
        
        .sensor-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
        }
        
        .sensor-icon {
            font-size: 1.8rem;
            opacity: 0.9;
        }
        
        .sensor-value {
            font-size: 2.2rem;
            font-weight: 800;
            margin: 10px 0;
            font-family: 'Segoe UI', Arial, sans-serif;
        }
        
        .sensor-unit {
            font-size: 0.9rem;
            color: #6c757d;
            font-weight: 500;
        }
        
        .sensor-status {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            margin-top: 10px;
        }
        
        /* Charts Section */
        .charts-section {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            margin-bottom: 25px;
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .section-title {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--dark);
            margin: 0;
        }
        
        /* Control Panel */
        .control-panel {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            margin-bottom: 25px;
        }
        
        .device-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }
        
        .device-card {
            background: var(--light);
            border-radius: 12px;
            padding: 20px;
            border: 2px solid #e9ecef;
            transition: all 0.3s;
        }
        
        .device-card:hover {
            border-color: var(--primary);
            background: white;
        }
        
        .device-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .device-icon-wrapper {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            background: rgba(67, 97, 238, 0.1);
            color: var(--primary);
        }
        
        .device-info h5 {
            margin: 0;
            font-weight: 700;
            font-size: 1.1rem;
        }
        
        .device-info p {
            margin: 5px 0 0 0;
            font-size: 0.85rem;
            color: #6c757d;
        }
        
        .control-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .control-btn {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.95rem;
            transition: all 0.3s;
            cursor: pointer;
        }
        
        .control-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        .control-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .btn-on {
            background: linear-gradient(135deg, var(--success) 0%, #20c997 100%);
            color: white;
        }
        
        .btn-off {
            background: linear-gradient(135deg, var(--danger) 0%, #e83e8c 100%);
            color: white;
        }
        
        .btn-on.active {
            box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.3);
        }
        
        .btn-off.active {
            box-shadow: 0 0 0 3px rgba(220, 53, 69, 0.3);
        }
        
        .device-status {
            text-align: center;
            margin-top: 10px;
        }
        
        .status-badge {
            display: inline-block;
            padding: 6px 15px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        .status-on {
            background: rgba(40, 167, 69, 0.15);
            color: var(--success);
        }
        
        .status-off {
            background: rgba(108, 117, 125, 0.15);
            color: #6c757d;
        }

        /* Auto Mode Card */
        .auto-mode-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
        }
        
        .auto-mode-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .auto-mode-icon {
            font-size: 1.8rem;
        }
        
        .form-switch-xl .form-check-input {
            width: 60px;
            height: 30px;
            margin-top: 0;
        }
        
        /* Evaluation Section */
        .evaluation-section {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
        }
        
        .evaluation-header {
            text-align: center;
            margin-bottom: 25px;
        }
        
        .overall-score {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            font-size: 2.2rem;
            font-weight: 800;
            color: white;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }
        
        .score-success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }
        
        .score-warning {
            background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%);
        }
        
        .score-danger {
            background: linear-gradient(135deg, #dc3545 0%, #e83e8c 100%);
        }
        
        .progress-container {
            margin: 25px 0;
        }
        
        .progress {
            height: 25px;
            border-radius: 12px;
            background: #e9ecef;
            overflow: hidden;
        }
        
        .progress-bar {
            border-radius: 12px;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: width 1s ease-in-out;
        }
        
        .evaluation-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .eval-item {
            background: var(--light);
            border-radius: 10px;
            padding: 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .eval-label {
            font-weight: 600;
            color: var(--dark);
        }
        
        .eval-value {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
        }
        
        /* Footer */
        .dashboard-footer {
            text-align: center;
            padding: 20px;
            color: #6c757d;
            font-size: 0.9rem;
            margin-top: 30px;
        }
        
        .footer-links {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 10px;
        }
        
        .footer-link {
            color: var(--primary);
            text-decoration: none;
            transition: color 0.3s;
        }
        
        .footer-link:hover {
            color: var(--secondary);
        }
        
        /* Alert styles */
        .alert-custom {
            border-radius: 12px;
            border: none;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        /* Responsive */
        @media (max-width: 1200px) {
            .sensor-grid {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            }
        }
        
        @media (max-width: 992px) {
            .dashboard-header {
                flex-direction: column;
                gap: 15px;
            }
            
            .nav-menu {
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .sensor-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 768px) {
            .main-container {
                padding: 15px;
            }
            
            .sensor-grid {
                grid-template-columns: 1fr;
            }
            
            .device-grid {
                grid-template-columns: 1fr;
            }
            
            .evaluation-grid {
                grid-template-columns: 1fr;
            }
            
            .nav-btn {
                padding: 8px 15px;
                font-size: 0.9rem;
            }
            
            .sensor-value {
                font-size: 1.8rem;
            }
        }
        
        /* Animations */
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .pulse {
            animation: pulse 2s infinite;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--secondary);
        }
        
        /* Loading overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            display: none;
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
    </div>

    <div class="main-container">
        <!-- Header v·ªõi Navigation -->
        <div class="dashboard-header d-flex justify-content-between align-items-center flex-wrap gap-3">
            <div class="logo-area">
                <div>
                    <i class="fas fa-school logo-icon"></i>
                </div>
                <div>
                    <h1 class="logo-text">CLASSGUARD</h1>
                    <p class="logo-subtext">H·ªá th·ªëng gi√°m s√°t m√¥i tr∆∞·ªùng l·ªõp h·ªçc th√¥ng minh</p>
                    <p class="logo-subtext">M√£ d·ª± √°n: 19016</p>
                </div>
            </div>
            
            <div class="nav-menu">
                <a href="/dashboard" class="nav-btn nav-btn-primary">
                    <i class="fas fa-tachometer-alt"></i>
                    <span>Dashboard</span>
                </a>
                
                {% if role in ['admin', 'teacher'] %}
                <a href="/data" class="nav-btn nav-btn-outline">
                    <i class="fas fa-database"></i>
                    <span>D·ªØ li·ªáu</span>
                </a>
                {% endif %}
                
                {% if role == 'admin' %}
                <a href="/settings_page" class="nav-btn nav-btn-warning">
                    <i class="fas fa-cog"></i>
                    <span>C√†i ƒë·∫∑t</span>
                </a>
                {% endif %}
                
                <a href="/export_csv" class="nav-btn nav-btn-success">
                    <i class="fas fa-file-export"></i>
                    <span>Xu·∫•t b√°o c√°o</span>
                </a>
            </div>
            
            <div class="d-flex align-items-center gap-3">
                <div class="time-display">
                    <p class="current-time" id="current-time">--:--:--</p>
                    <p class="time-label">
                        <span class="real-time-indicator" id="realtime-indicator">Th·ªùi gian th·ª±c</span>
                    </p>
                </div>
                
                <!-- Tr·∫°ng th√°i k·∫øt n·ªëi ESP32 -->
                <div class="connection-badge" id="esp32-status-badge">
                    <i class="fas fa-microchip" id="esp32-icon"></i>
                    <span id="esp32-status-text">ƒêang k·∫øt n·ªëi...</span>
                </div>
                
                <div class="user-info">
                    <div class="user-avatar">
                        <i class="fas fa-user-circle"></i>
                    </div>
                    <div class="user-details">
                        <h3 class="user-name">{{ name }}</h3>
                        <p class="user-role">
                            <span class="badge bg-{{ 'danger' if role == 'admin' else 'warning' if role == 'teacher' else 'info' if role == 'student' else 'secondary' }}">
                                {{ 'Qu·∫£n tr·ªã vi√™n' if role == 'admin' else 'Gi√°o vi√™n' if role == 'teacher' else 'H·ªçc sinh' if role == 'student' else 'Kh√°ch xem' }}
                            </span>
                        </p>
                        <p class="login-time">
                            <i class="fas fa-clock me-1"></i>
                            {{ login_time }}
                        </p>
                    </div>
                    <a href="/logout" class="btn btn-sm btn-light">
                        <i class="fas fa-sign-out-alt"></i>
                    </a>
                </div>
            </div>
        </div>

        <!-- Alert Container -->
        <div id="alert-container" class="mb-3"></div>

        <!-- Auto Mode Notice -->
        <div id="control-notice" class="alert alert-custom alert-warning d-flex align-items-center mb-3">
            <i class="fas fa-robot me-2 fs-4"></i>
            <div>
                <strong>Ch·∫ø ƒë·ªô t·ª± ƒë·ªông ƒëang b·∫≠t</strong>
                <div class="small">H·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông ƒëi·ªÅu ch·ªânh thi·∫øt b·ªã d·ª±a tr√™n ng∆∞·ª°ng c√†i ƒë·∫∑t</div>
            </div>
        </div>

        <!-- Sensor Cards -->
        <div class="sensor-grid fade-in">
            <!-- Nhi·ªát ƒë·ªô -->
            <div class="sensor-card border-warning" id="temp-card">
                <div class="sensor-header">
                    <div>
                        <h5 class="fw-bold mb-1">üå°Ô∏è Nhi·ªát ƒë·ªô</h5>
                        <p class="text-muted small mb-0">ƒê·ªô Celsius</p>
                    </div>
                    <i class="fas fa-thermometer-half sensor-icon text-warning"></i>
                </div>
                <div class="sensor-value text-warning" id="temp-value">{{ data.nhiet_do|round(1) }}</div>
                <div class="sensor-unit">¬∞C</div>
                <div class="mt-3">
                    <span class="sensor-status bg-{{ 'danger' if data.nhiet_do > 32 else 'warning' if data.nhiet_do > 28 else 'success' }} text-white" id="temp-status">
                        {{ 'N√≥ng' if data.nhiet_do > 32 else '·∫§m' if data.nhiet_do > 28 else 'T·ªët' }}
                    </span>
                </div>
                <div class="mt-2 small text-muted">
                    <i class="fas fa-sync-alt me-1"></i>
                    C·∫≠p nh·∫≠t: <span id="last-update">{{ data.timestamp }}</span>
                </div>
            </div>

            <!-- ƒê·ªô ·∫©m -->
            <div class="sensor-card border-info" id="hum-card">
                <div class="sensor-header">
                    <div>
                        <h5 class="fw-bold mb-1">üíß ƒê·ªô ·∫©m</h5>
                        <p class="text-muted small mb-0">ƒê·ªô ·∫©m kh√¥ng kh√≠</p>
                    </div>
                    <i class="fas fa-tint sensor-icon text-info"></i>
                </div>
                <div class="sensor-value text-info" id="hum-value">{{ data.do_am|round(1) }}</div>
                <div class="sensor-unit">%</div>
                <div class="mt-3">
                    <span class="sensor-status bg-{{ 'warning' if data.do_am < 40 or data.do_am > 70 else 'success' }} text-white" id="hum-status">
                        {{ 'Kh√¥' if data.do_am < 40 else '·∫®m' if data.do_am > 70 else 'T·ªët' }}
                    </span>
                </div>
            </div>

            <!-- √Ånh s√°ng -->
            <div class="sensor-card border-warning" id="light-card">
                <div class="sensor-header">
                    <div>
                        <h5 class="fw-bold mb-1">‚òÄÔ∏è √Ånh s√°ng</h5>
                        <p class="text-muted small mb-0">C∆∞·ªùng ƒë·ªô √°nh s√°ng</p>
                    </div>
                    <i class="fas fa-sun sensor-icon text-warning"></i>
                </div>
                <div class="sensor-value text-warning" id="light-value">{{ data.anh_sang|round }}</div>
                <div class="sensor-unit">lux</div>
                <div class="mt-3">
                    <span class="sensor-status bg-{{ 'danger' if data.anh_sang < 200 else 'warning' if data.anh_sang < 300 else 'success' }} text-white" id="light-status">
                        {{ 'T·ªëi' if data.anh_sang < 200 else 'V·ª´a' if data.anh_sang < 300 else 'S√°ng' }}
                    </span>
                </div>
            </div>

            <!-- Ch·∫•t l∆∞·ª£ng kh√¥ng kh√≠ -->
            <div class="sensor-card border-success" id="air-card">
                <div class="sensor-header">
                    <div>
                        <h5 class="fw-bold mb-1">üí® Ch·∫•t l∆∞·ª£ng KK</h5>
                        <p class="text-muted small mb-0">N·ªìng ƒë·ªô CO2</p>
                    </div>
                    <i class="fas fa-wind sensor-icon text-success"></i>
                </div>
                <div class="sensor-value text-success" id="air-value">{{ data.chat_luong_kk|round }}</div>
                <div class="sensor-unit">PPM</div>
                <div class="mt-3">
                    <span class="sensor-status bg-{{ 'danger' if data.chat_luong_kk > 800 else 'warning' if data.chat_luong_kk > 400 else 'success' }} text-white" id="air-status">
                        {{ '√î nhi·ªÖm' if data.chat_luong_kk > 800 else 'TB' if data.chat_luong_kk > 400 else 'T·ªët' }}
                    </span>
                </div>
            </div>

            <!-- ƒê·ªô ·ªìn -->
            <div class="sensor-card border-danger" id="noise-card">
                <div class="sensor-header">
                    <div>
                        <h5 class="fw-bold mb-1">üîä ƒê·ªô ·ªìn</h5>
                        <p class="text-muted small mb-0">M·ª©c √¢m thanh</p>
                    </div>
                    <i class="fas fa-volume-up sensor-icon text-danger"></i>
                </div>
                <div class="sensor-value text-danger" id="noise-value">{{ data.do_on|round }}</div>
                <div class="sensor-unit">dB</div>
                <div class="mt-3">
                    <span class="sensor-status bg-{{ 'danger' if data.do_on > 70 else 'warning' if data.do_on > 50 else 'success' }} text-white" id="noise-status">
                        {{ '·ªín' if data.do_on > 70 else 'BT' if data.do_on > 50 else 'Y√™n tƒ©nh' }}
                    </span>
                </div>
            </div>
        </div>

        <!-- Charts Section -->
        <div class="charts-section fade-in">
            <div class="section-header">
                <h2 class="section-title">
                    <i class="fas fa-chart-line me-2"></i>Bi·ªÉu ƒë·ªì d·ªØ li·ªáu
                </h2>
                <div class="d-flex align-items-center gap-3">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="chartToggle" style="width: 60px; height: 30px;">
                        <label class="form-check-label fw-bold" for="chartToggle">
                            <span id="chartLabel">Bi·ªÉu ƒë·ªì ƒë∆∞·ªùng</span>
                        </label>
                    </div>
                    <button class="btn btn-sm btn-outline-primary" id="refreshCharts">
                        <i class="fas fa-redo"></i> L√†m m·ªõi
                    </button>
                </div>
            </div>
            
            <div class="chart-container">
                <div id="lineChartContainer">
                    <canvas id="lineChart"></canvas>
                </div>
                <div id="barChartContainer" style="display: none;">
                    <canvas id="barChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Control Panel -->
        <div class="control-panel fade-in">
            <div class="section-header mb-4">
                <h2 class="section-title">
                    <i class="fas fa-gamepad me-2"></i>ƒêi·ªÅu khi·ªÉn thi·∫øt b·ªã
                </h2>
                <div class="d-flex align-items-center gap-3">
                    <span class="badge bg-{{ 'success' if settings.auto_mode else 'secondary' }} p-2" id="auto-mode-status">
                        {{ 'ƒêANG B·∫¨T' if settings.auto_mode else 'ƒêANG T·∫ÆT' }}
                    </span>
                    <div class="form-check form-switch form-switch-xl">
                        <input class="form-check-input" type="checkbox" id="autoModeToggle" 
                               {% if settings.auto_mode %}checked{% endif %}>
                        <label class="form-check-label fw-bold" for="autoModeToggle">
                            Ch·∫ø ƒë·ªô t·ª± ƒë·ªông
                        </label>
                    </div>
                </div>
            </div>
            
            {% if role in ['admin', 'teacher'] %}
            <div class="device-grid">
                <!-- Qu·∫°t -->
                <div class="device-card">
                    <div class="device-header">
                        <div class="device-icon-wrapper">
                            <i class="fas fa-fan" id="quat-icon"></i>
                        </div>
                        <div class="device-info">
                            <h5>üåÄ Qu·∫°t l√†m m√°t</h5>
                            <p>ƒêi·ªÅu ch·ªânh nhi·ªát ƒë·ªô ph√≤ng</p>
                        </div>
                    </div>
                    
                    <div class="control-buttons">
                        <button class="control-btn btn-on {{ 'active' if data.quat == 'B·∫¨T' else '' }}" 
                                data-device="quat" 
                                data-action="B·∫¨T"
                                id="quat-on-btn"
                                {% if settings.auto_mode %}disabled{% endif %}>
                            <i class="fas fa-play me-1"></i> B·∫¨T
                        </button>
                        <button class="control-btn btn-off {{ 'active' if data.quat == 'T·∫ÆT' else '' }}" 
                                data-device="quat" 
                                data-action="T·∫ÆT"
                                id="quat-off-btn"
                                {% if settings.auto_mode %}disabled{% endif %}>
                            <i class="fas fa-stop me-1"></i> T·∫ÆT
                        </button>
                    </div>
                    
                    <div class="device-status">
                        <span class="status-badge status-{{ 'on' if data.quat == 'B·∫¨T' else 'off' }}" id="quat-status">
                            {{ data.quat }}
                        </span>
                    </div>
                </div>

                <!-- ƒê√®n -->
                <div class="device-card">
                    <div class="device-header">
                        <div class="device-icon-wrapper">
                            <i class="fas fa-lightbulb" id="den-icon"></i>
                        </div>
                        <div class="device-info">
                            <h5>üí° ƒê√®n chi·∫øu s√°ng</h5>
                            <p>ƒêi·ªÅu ch·ªânh √°nh s√°ng l·ªõp h·ªçc</p>
                        </div>
                    </div>
                    
                    <div class="control-buttons">
                        <button class="control-btn btn-on {{ 'active' if data.den == 'B·∫¨T' else '' }}" 
                                data-device="den" 
                                data-action="B·∫¨T"
                                id="den-on-btn"
                                {% if settings.auto_mode %}disabled{% endif %}>
                            <i class="fas fa-lightbulb me-1"></i> B·∫¨T
                        </button>
                        <button class="control-btn btn-off {{ 'active' if data.den == 'T·∫ÆT' else '' }}" 
                                data-device="den" 
                                data-action="T·∫ÆT"
                                id="den-off-btn"
                                {% if settings.auto_mode %}disabled{% endif %}>
                            <i class="fas fa-lightbulb me-1"></i> T·∫ÆT
                        </button>
                    </div>
                    
                    <div class="device-status">
                        <span class="status-badge status-{{ 'on' if data.den == 'B·∫¨T' else 'off' }}" id="den-status">
                            {{ data.den }}
                        </span>
                    </div>
                </div>

                <!-- C·ª≠a s·ªï -->
                <div class="device-card">
                    <div class="device-header">
                        <div class="device-icon-wrapper">
                            <i class="fas fa-door-closed" id="cua_so-icon"></i>
                        </div>
                        <div class="device-info">
                            <h5>üö™ C·ª≠a s·ªï</h5>
                            <p>Th√¥ng tho√°ng kh√¥ng kh√≠</p>
                        </div>
                    </div>
                    
                    <div class="control-buttons">
                        <button class="control-btn btn-on {{ 'active' if data.cua_so == 'M·ªû' else '' }}" 
                                data-device="cua_so" 
                                data-action="M·ªû"
                                id="cua_so-on-btn"
                                {% if settings.auto_mode %}disabled{% endif %}>
                            <i class="fas fa-door-open me-1"></i> M·ªû
                        </button>
                        <button class="control-btn btn-off {{ 'active' if data.cua_so == 'ƒê√ìNG' else '' }}" 
                                data-device="cua_so" 
                                data-action="ƒê√ìNG"
                                id="cua_so-off-btn"
                                {% if settings.auto_mode %}disabled{% endif %}>
                            <i class="fas fa-door-closed me-1"></i> ƒê√ìNG
                        </button>
                    </div>
                    
                    <div class="device-status">
                        <span class="status-badge status-{{ 'on' if data.cua_so == 'M·ªû' else 'off' }}" id="cua_so-status">
                            {{ data.cua_so }}
                        </span>
                    </div>
                </div>

                <!-- C·∫£nh b√°o (LU√îN ƒê∆Ø·ª¢C ƒêI·ªÄU KHI·ªÇN TH·ª¶ C√îNG) -->
                <div class="device-card">
                    <div class="device-header">
                        <div class="device-icon-wrapper">
                            <i class="fas fa-bell" id="canh_bao-icon"></i>
                        </div>
                        <div class="device-info">
                            <h5>‚ö†Ô∏è H·ªá th·ªëng c·∫£nh b√°o</h5>
                            <p>B√°o ƒë·ªông khi c√≥ v·∫•n ƒë·ªÅ</p>
                        </div>
                    </div>
                    
                    <div class="control-buttons">
                        <button class="control-btn btn-on {{ 'active' if data.canh_bao == 'B·∫¨T' else '' }}" 
                                data-device="canh_bao" 
                                data-action="B·∫¨T"
                                id="canh_bao-on-btn">
                            <i class="fas fa-bell me-1"></i> B·∫¨T
                        </button>
                        <button class="control-btn btn-off {{ 'active' if data.canh_bao == 'T·∫ÆT' else '' }}" 
                                data-device="canh_bao" 
                                data-action="T·∫ÆT"
                                id="canh_bao-off-btn">
                            <i class="fas fa-bell-slash me-1"></i> T·∫ÆT
                        </button>
                    </div>
                    
                    <div class="device-status">
                        <span class="status-badge status-{{ 'on' if data.canh_bao == 'B·∫¨T' else 'off' }}" id="canh_bao-status">
                            {{ data.canh_bao }}
                        </span>
                    </div>
                </div>
            </div>
            
            <div class="auto-mode-card mt-4">
                <div class="auto-mode-header">
                    <i class="fas fa-robot auto-mode-icon"></i>
                    <div class="flex-grow-1">
                        <h4 class="mb-1">ü§ñ Ch·∫ø ƒë·ªô t·ª± ƒë·ªông th√¥ng minh</h4>
                        <p class="mb-0 small opacity-90">H·ªá th·ªëng t·ª± ƒë·ªông ƒëi·ªÅu khi·ªÉn thi·∫øt b·ªã d·ª±a tr√™n ng∆∞·ª°ng c√†i ƒë·∫∑t</p>
                    </div>
                    <div class="form-check form-switch form-switch-xl">
                        <input class="form-check-input" type="checkbox" id="autoModeToggle2" 
                               {% if settings.auto_mode %}checked{% endif %}>
                    </div>
                </div>
                <div class="mt-3">
                    <div class="row g-2">
                        <div class="col-md-3">
                            <div class="text-center p-2 bg-white bg-opacity-10 rounded">
                                <div class="small">üå°Ô∏è Nhi·ªát ƒë·ªô</div>
                                <div class="fw-bold" id="temp-threshold">{{ settings.temp_min }}¬∞C - {{ settings.temp_max }}¬∞C</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center p-2 bg-white bg-opacity-10 rounded">
                                <div class="small">‚òÄÔ∏è √Ånh s√°ng</div>
                                <div class="fw-bold" id="light-threshold">{{ settings.light_min }}+ lux</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center p-2 bg-white bg-opacity-10 rounded">
                                <div class="small">üí® Ch·∫•t l∆∞·ª£ng KK</div>
                                <div class="fw-bold" id="air-threshold">{{ settings.air_max }} PPM</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center p-2 bg-white bg-opacity-10 rounded">
                                <div class="small">üîä ƒê·ªô ·ªìn</div>
                                <div class="fw-bold" id="noise-threshold">{{ settings.noise_max }} dB</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            {% else %}
            <div class="alert alert-info d-flex align-items-center">
                <i class="fas fa-info-circle fs-4 me-3"></i>
                <div>
                    <h5 class="mb-2">Ch·ªâ d√†nh cho gi√°o vi√™n v√† qu·∫£n tr·ªã vi√™n</h5>
                    <p class="mb-0">B·∫°n kh√¥ng c√≥ quy·ªÅn ƒëi·ªÅu khi·ªÉn thi·∫øt b·ªã. Vui l√≤ng li√™n h·ªá qu·∫£n tr·ªã vi√™n n·∫øu c·∫ßn thi·∫øt.</p>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Evaluation Section -->
        <div class="evaluation-section fade-in">
            <div class="evaluation-header">
                <div class="overall-score score-{{ evaluation.overall_class }}" id="score-value">
                    {{ evaluation.total_score }}/10
                </div>
                <h2 class="mt-3" id="overall-evaluation">{{ evaluation.overall }}</h2>
                <p class="text-muted mb-0" id="class-eval">{{ evaluation.class_eval }}</p>
            </div>
            
            <div class="progress-container">
                <div class="d-flex justify-content-between mb-2">
                    <span>ƒêi·ªÉm ƒë√°nh gi√° m√¥i tr∆∞·ªùng</span>
                    <span class="fw-bold">{{ evaluation.percentage }}%</span>
                </div>
                <div class="progress">
                    <div class="progress-bar bg-{{ evaluation.overall_class }}" 
                         id="score-progress" style="width: {{ evaluation.percentage }}%">
                        {{ evaluation.percentage }}%
                    </div>
                </div>
            </div>
            
            <div class="alert alert-custom alert-{{ evaluation.overall_class }} d-flex align-items-center mt-4">
                <i class="fas fa-comment-medical fs-4 me-3"></i>
                <div>
                    <h5 class="mb-1">Khuy·∫øn ngh·ªã</h5>
                    <p class="mb-0" id="advice-text">{{ evaluation.advice }}</p>
                </div>
            </div>
            
            <h5 class="mt-4 mb-3">ƒê√°nh gi√° chi ti·∫øt:</h5>
            <div class="evaluation-grid" id="evaluation-details">
                {% for item in evaluation.evaluations %}
                <div class="eval-item">
                    <span class="eval-label">{{ item[0] }}</span>
                    <span class="eval-value bg-{{ item[2] }} text-white">{{ item[1] }}</span>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Footer -->
        <div class="dashboard-footer">
            <p class="mb-2">
                <strong>CLASSGUARD</strong> - H·ªá th·ªëng gi√°m s√°t m√¥i tr∆∞·ªùng l·ªõp h·ªçc th√¥ng minh - M√£ d·ª± √°n: 19016
            </p>
            <p class="small text-muted mb-3">
                <i class="fas fa-sync-alt"></i> D·ªØ li·ªáu c·∫≠p nh·∫≠t th·ªùi gian th·ª±c | 
                <i class="fas fa-shield-alt"></i> Phi√™n b·∫£n 4.0 | 
                <i class="fas fa-heart text-danger"></i> D·ª± √°n Khoa h·ªçc K·ªπ thu·∫≠t - THCS
            </p>
            <div class="footer-links">
                <a href="#" class="footer-link"><i class="fas fa-question-circle me-1"></i> Tr·ª£ gi√∫p</a>
                <a href="#" class="footer-link"><i class="fas fa-info-circle me-1"></i> Gi·ªõi thi·ªáu</a>
                <a href="#" class="footer-link"><i class="fas fa-envelope me-1"></i> Li√™n h·ªá</a>
                <a href="#" class="footer-link"><i class="fas fa-shield-alt me-1"></i> B·∫£o m·∫≠t</a>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // ========== KH·ªûI T·∫†O SOCKETIO ==========
        const socket = io({
            reconnection: true,
            reconnectionAttempts: 5,
            reconnectionDelay: 1000
        });
        
        let isAutoMode = {{ settings.auto_mode|lower }};
        let esp32Connected = {{ esp32_connected|lower }};
        let lastUpdateTime = null;
        let refreshInterval = null;
        
        // ========== X·ª¨ L√ù K·∫æT N·ªêI SOCKETIO ==========
        socket.on('connect', function() {
            console.log('‚úÖ ƒê√£ k·∫øt n·ªëi WebSocket');
            updateEsp32Status('connected');
            showToast('‚úÖ K·∫øt n·ªëi', 'ƒê√£ k·∫øt n·ªëi v·ªõi server th√†nh c√¥ng', 'success');
        });
        
        socket.on('disconnect', function() {
            console.log('‚ùå M·∫•t k·∫øt n·ªëi WebSocket');
            updateEsp32Status('disconnected');
            showToast('‚ö†Ô∏è C·∫£nh b√°o', 'M·∫•t k·∫øt n·ªëi v·ªõi server', 'warning');
        });
        
        socket.on('connect_error', function(error) {
            console.log('‚ùå L·ªói k·∫øt n·ªëi WebSocket:', error);
            updateEsp32Status('disconnected');
        });
        
        socket.on('sensor_update', function(data) {
            console.log('üì° Nh·∫≠n d·ªØ li·ªáu th·ªùi gian th·ª±c:', data);
            lastUpdateTime = new Date();
            updateSensorDisplays(data.sensors);
            updateEvaluation(data.evaluation);
            updateDeviceStatus(data.sensors);
            
            // C·∫≠p nh·∫≠t bi·ªÉu ƒë·ªì n·∫øu ƒëang hi·ªÉn th·ªã
            if (window.updateCharts) {
                updateCharts(data);
            }
        });
        
        socket.on('esp32_status', function(data) {
            console.log('üì° Tr·∫°ng th√°i ESP32:', data.status);
            esp32Connected = data.status === 'connected';
            updateEsp32Status(data.status);
            
            if (data.status === 'connected') {
                showToast('‚úÖ K·∫øt n·ªëi', 'ESP32 ƒë√£ k·∫øt n·ªëi', 'success');
            } else if (data.status === 'disconnected') {
                showToast('‚ö†Ô∏è C·∫£nh b√°o', 'ESP32 m·∫•t k·∫øt n·ªëi', 'warning');
            }
        });
        
        socket.on('command_ack', function(data) {
            console.log('‚úÖ ESP32 x√°c nh·∫≠n l·ªánh:', data);
            showToast('‚úÖ Th√†nh c√¥ng', 'Thi·∫øt b·ªã ƒë√£ th·ª±c thi l·ªánh', 'success');
        });
        
        socket.on('command_sent', function(data) {
            console.log('üì§ ƒê√£ g·ª≠i l·ªánh ƒë·∫øn ESP32:', data.command);
        });
        
        // ========== H√ÄM C·∫¨P NH·∫¨T GIAO DI·ªÜN ==========
       function updateEsp32Status(connected) {
        const badge = document.getElementById('esp32-status-badge');
        const text = document.getElementById('esp32-status-text');
        const icon = document.getElementById('esp32-icon');
        const indicator = document.getElementById('realtime-indicator');
        
        if (connected) {
            badge.className = 'connection-badge connected';
            text.textContent = 'ESP32: ƒê√£ k·∫øt n·ªëi';
            icon.className = 'fas fa-microchip';
            if (indicator) {
                indicator.classList.remove('offline');
                indicator.classList.add('real-time-indicator');
            }
        } else {
            badge.className = 'connection-badge disconnected';
            text.textContent = 'ESP32: M·∫•t k·∫øt n·ªëi';
            icon.className = 'fas fa-microchip';
            if (indicator) {
                indicator.classList.add('offline');
                indicator.classList.remove('real-time-indicator');
            }
        }
    }        
        function updateSensorDisplays(sensors) {
            // C·∫≠p nh·∫≠t gi√° tr·ªã
            updateElement('temp-value', sensors.nhiet_do.toFixed(1));
            updateElement('hum-value', sensors.do_am.toFixed(1));
            updateElement('light-value', Math.round(sensors.anh_sang));
            updateElement('air-value', Math.round(sensors.chat_luong_kk));
            updateElement('noise-value', Math.round(sensors.do_on));
            updateElement('last-update', sensors.timestamp || '--:--:--');
            
            // C·∫≠p nh·∫≠t tr·∫°ng th√°i
            updateSensorStatus('temp', sensors.nhiet_do);
            updateSensorStatus('hum', sensors.do_am);
            updateSensorStatus('light', sensors.anh_sang);
            updateSensorStatus('air', sensors.chat_luong_kk);
            updateSensorStatus('noise', sensors.do_on);
            
            // C·∫≠p nh·∫≠t m√†u s·∫Øc
            updateSensorColor('temp', sensors.nhiet_do);
            updateSensorColor('hum', sensors.do_am);
            updateSensorColor('light', sensors.anh_sang);
            updateSensorColor('air', sensors.chat_luong_kk);
            updateSensorColor('noise', sensors.do_on);
        }
        
        function updateElement(id, value) {
            const element = document.getElementById(id);
            if (element) {
                element.textContent = value;
            }
        }
        
        function updateSensorStatus(type, value) {
            const element = document.getElementById(`${type}-status`);
            if (!element) return;
            
            let status = '';
            let colorClass = 'success';
            
            if (type === 'temp') {
                if (value > 32) {
                    status = 'N√≥ng';
                    colorClass = 'danger';
                } else if (value > 28) {
                    status = '·∫§m';
                    colorClass = 'warning';
                } else {
                    status = 'T·ªët';
                    colorClass = 'success';
                }
            } else if (type === 'hum') {
                if (value < 40 || value > 70) {
                    status = value < 40 ? 'Kh√¥' : '·∫®m';
                    colorClass = 'warning';
                } else {
                    status = 'T·ªët';
                    colorClass = 'success';
                }
            } else if (type === 'light') {
                if (value < 200) {
                    status = 'T·ªëi';
                    colorClass = 'danger';
                } else if (value < 300) {
                    status = 'V·ª´a';
                    colorClass = 'warning';
                } else {
                    status = 'S√°ng';
                    colorClass = 'success';
                }
            } else if (type === 'air') {
                if (value > 800) {
                    status = '√î nhi·ªÖm';
                    colorClass = 'danger';
                } else if (value > 400) {
                    status = 'TB';
                    colorClass = 'warning';
                } else {
                    status = 'T·ªët';
                    colorClass = 'success';
                }
            } else if (type === 'noise') {
                if (value > 70) {
                    status = '·ªín';
                    colorClass = 'danger';
                } else if (value > 50) {
                    status = 'BT';
                    colorClass = 'warning';
                } else {
                    status = 'Y√™n tƒ©nh';
                    colorClass = 'success';
                }
            }
            
            element.textContent = status;
            element.className = `sensor-status bg-${colorClass} text-white`;
        }
        
        function updateSensorColor(type, value) {
            const element = document.getElementById(`${type}-card`);
            if (!element) return;
            
            let colorClass = 'border-success';
            
            if (type === 'temp') {
                if (value > 32) colorClass = 'border-danger';
                else if (value > 28) colorClass = 'border-warning';
                else if (value >= 20) colorClass = 'border-success';
                else colorClass = 'border-danger';
            } else if (type === 'hum') {
                if (value < 40 || value > 70) colorClass = 'border-warning';
                else colorClass = 'border-success';
            } else if (type === 'light') {
                if (value < 200) colorClass = 'border-danger';
                else if (value < 300) colorClass = 'border-warning';
                else colorClass = 'border-success';
            } else if (type === 'air') {
                if (value > 800) colorClass = 'border-danger';
                else if (value > 400) colorClass = 'border-warning';
                else colorClass = 'border-success';
            } else if (type === 'noise') {
                if (value > 70) colorClass = 'border-danger';
                else if (value > 50) colorClass = 'border-warning';
                else colorClass = 'border-success';
            }
            
            element.classList.remove('border-success', 'border-warning', 'border-danger');
            element.classList.add(colorClass);
        }
        
        function updateDeviceStatus(sensors) {
            const devices = ['quat', 'den', 'cua_so', 'canh_bao'];
            
            devices.forEach(device => {
                const status = sensors[device];
                const isOn = status === 'B·∫¨T' || status === 'M·ªû';
                
                // C·∫≠p nh·∫≠t icon
                const iconElement = document.getElementById(`${device}-icon`);
                if (iconElement) {
                    iconElement.classList.remove('fa-spin', 'fa-shake', 'door-open', 'door-closed');
                    
                    if (device === 'quat') {
                        iconElement.className = isOn ? 'fas fa-fan fa-spin text-success fs-4' : 'fas fa-fan text-secondary fs-4';
                    } else if (device === 'den') {
                        iconElement.className = isOn ? 'fas fa-lightbulb text-warning fs-4' : 'fas fa-lightbulb text-secondary fs-4';
                        iconElement.style.filter = isOn ? 'brightness(1.3)' : 'brightness(0.7)';
                    } else if (device === 'canh_bao') {
                        iconElement.className = isOn ? 'fas fa-bell fa-shake text-danger fs-4' : 'fas fa-bell text-secondary fs-4';
                    } else if (device === 'cua_so') {
                        if (isOn) {
                            iconElement.className = 'fas fa-door-open text-success fs-4 door-open';
                            iconElement.style.color = '#28a745';
                            iconElement.style.transform = 'scale(1.1)';
                        } else {
                            iconElement.className = 'fas fa-door-closed text-danger fs-4 door-closed';
                            iconElement.style.color = '#dc3545';
                            iconElement.style.transform = 'scale(1)';
                        }
                    }
                }
                
                // C·∫≠p nh·∫≠t n√∫t ƒëi·ªÅu khi·ªÉn
                const onBtn = document.getElementById(`${device}-on-btn`);
                const offBtn = document.getElementById(`${device}-off-btn`);
                
                if (onBtn && offBtn) {
                    onBtn.classList.remove('btn-success', 'btn-outline-success', 'shadow', 'active');
                    offBtn.classList.remove('btn-danger', 'btn-outline-danger', 'shadow', 'active');
                    
                    if (isOn) {
                        onBtn.classList.add('btn-success', 'shadow', 'active');
                        offBtn.classList.add('btn-outline-danger');
                    } else {
                        offBtn.classList.add('btn-danger', 'shadow', 'active');
                        onBtn.classList.add('btn-outline-success');
                    }
                }
                
                // C·∫≠p nh·∫≠t tr·∫°ng th√°i text
                updateElement(`${device}-status`, status);
                const statusElement = document.getElementById(`${device}-status`);
                if (statusElement) {
                    statusElement.className = `status-badge status-${isOn ? 'on' : 'off'}`;
                }
            });
        }
        
        function updateEvaluation(evaluation) {
            if (!evaluation) return;
            
            // ƒê√°nh gi√° t·ªïng th·ªÉ
            updateElement('overall-evaluation', evaluation.overall);
            const overallElement = document.getElementById('overall-evaluation');
            if (overallElement) {
                overallElement.className = `badge bg-${evaluation.overall_class} p-2 fs-5`;
            }
            
            // ƒêi·ªÉm s·ªë
            updateElement('score-value', `${evaluation.total_score}/10`);
            const scoreElement = document.getElementById('score-value');
            if (scoreElement) {
                scoreElement.classList.remove('score-success', 'score-warning', 'score-danger');
                scoreElement.classList.add(`score-${evaluation.overall_class}`);
            }
            
            // Progress bar
            const progressBar = document.getElementById('score-progress');
            if (progressBar) {
                progressBar.style.width = `${evaluation.percentage}%`;
                progressBar.textContent = `${evaluation.percentage}%`;
                progressBar.className = `progress-bar bg-${evaluation.overall_class}`;
            }
            
            // Khuy·∫øn ngh·ªã
            updateElement('advice-text', evaluation.advice);
            const adviceElement = document.getElementById('advice-text');
            if (adviceElement) {
                adviceElement.parentElement.parentElement.className = `alert alert-custom alert-${evaluation.overall_class} d-flex align-items-center mt-4`;
            }
            
            // Ti·∫øt h·ªçc
            updateElement('class-eval', evaluation.class_eval);
            const classEvalElement = document.getElementById('class-eval');
            if (classEvalElement) {
                classEvalElement.className = `badge bg-${evaluation.class_color} p-2`;
            }
            
            // ƒê√°nh gi√° chi ti·∫øt
            const detailsElement = document.getElementById('evaluation-details');
            if (detailsElement && evaluation.evaluations) {
                let html = '';
                evaluation.evaluations.forEach(item => {
                    html += `
                        <div class="eval-item">
                            <span class="eval-label">${item[0]}</span>
                            <span class="eval-value bg-${item[2]} text-white">${item[1]}</span>
                        </div>
                    `;
                });
                detailsElement.innerHTML = html;
            }
        }
        
        // ========== H√ÄM ƒêI·ªÄU KHI·ªÇN ==========
        async function controlDevice(device, action) {
        console.log(`üéÆ G·ª≠i l·ªánh ƒëi·ªÅu khi·ªÉn: ${device} -> ${action}`);
        
        // Ki·ªÉm tra ch·∫ø ƒë·ªô t·ª± ƒë·ªông (tr·ª´ c·∫£nh b√°o)
        if (device !== 'canh_bao' && isAutoMode) {
            showToast('‚ö†Ô∏è C·∫£nh b√°o', 'H·ªá th·ªëng ƒëang ·ªü ch·∫ø ƒë·ªô t·ª± ƒë·ªông. T·∫Øt ch·∫ø ƒë·ªô t·ª± ƒë·ªông ƒë·ªÉ ƒëi·ªÅu khi·ªÉn th·ªß c√¥ng.', 'warning');
            return;
        }
        
        showLoading(true);
        
        try {
            // Map device v√† action sang command ESP32
            const commandMap = {
                'quat_B·∫¨T': 'FAN_ON',
                'quat_T·∫ÆT': 'FAN_OFF',
                'den_B·∫¨T': 'LIGHT_ON',
                'den_T·∫ÆT': 'LIGHT_OFF',
                'cua_so_M·ªû': 'WINDOW_OPEN',
                'cua_so_ƒê√ìNG': 'WINDOW_CLOSE',
                'canh_bao_B·∫¨T': 'ALARM_ON',
                'canh_bao_T·∫ÆT': 'ALARM_OFF'
            };
            
            const key = `${device}_${action}`;
            const command = commandMap[key];
            
            if (!command) {
                showToast('‚ùå L·ªói', 'L·ªánh kh√¥ng h·ª£p l·ªá', 'danger');
                showLoading(false);
                return;
            }
            
            const response = await fetch('/api/esp32/command', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    command: command,
                    value: action
                })
            });
            
            const result = await response.json();
            
            if (result.success) {
                showToast('‚úÖ Th√†nh c√¥ng', `ƒê√£ g·ª≠i l·ªánh ${action} ${device}`, 'success');
                // C·∫≠p nh·∫≠t UI ngay l·∫≠p t·ª©c
                updateDeviceUI(device, action);
                // L√†m m·ªõi d·ªØ li·ªáu sau 1 gi√¢y
                setTimeout(fetchSensorData, 1000);
            } else {
                showToast('‚ùå L·ªói', result.error || 'C√≥ l·ªói x·∫£y ra', 'danger');
            }
        } catch (error) {
            console.error('‚ùå L·ªói ƒëi·ªÅu khi·ªÉn:', error);
            showToast('‚ùå L·ªói', 'Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn server', 'danger');
        } finally {
            showLoading(false);
        }
    }
        
        function updateDeviceUI(device, action) {
            const isOn = action === 'B·∫¨T' || action === 'M·ªû';
            
            // C·∫≠p nh·∫≠t icon
            const iconElement = document.getElementById(`${device}-icon`);
            if (iconElement) {
                if (device === 'quat') {
                    iconElement.className = isOn ? 'fas fa-fan fa-spin text-success fs-4' : 'fas fa-fan text-secondary fs-4';
                } else if (device === 'den') {
                    iconElement.className = isOn ? 'fas fa-lightbulb text-warning fs-4' : 'fas fa-lightbulb text-secondary fs-4';
                } else if (device === 'canh_bao') {
                    iconElement.className = isOn ? 'fas fa-bell fa-shake text-danger fs-4' : 'fas fa-bell text-secondary fs-4';
                } else if (device === 'cua_so') {
                    iconElement.className = isOn ? 'fas fa-door-open text-success fs-4 door-open' : 'fas fa-door-closed text-danger fs-4 door-closed';
                }
            }
            
            // C·∫≠p nh·∫≠t text status
            updateElement(`${device}-status`, action);
            const statusElement = document.getElementById(`${device}-status`);
            if (statusElement) {
                statusElement.className = `status-badge status-${isOn ? 'on' : 'off'}`;
            }
        }
        
        async function updateAutoMode(enabled) {
            console.log(`ü§ñ C·∫≠p nh·∫≠t ch·∫ø ƒë·ªô t·ª± ƒë·ªông: ${enabled}`);
            
            showLoading(true);
            
            try {
                const response = await fetch('/update_settings', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        auto_mode: enabled
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    isAutoMode = enabled;
                    updateAutoModeUI(enabled);
                    showToast('‚úÖ Th√†nh c√¥ng', `Ch·∫ø ƒë·ªô t·ª± ƒë·ªông ƒë√£ ${enabled ? 'b·∫≠t' : 't·∫Øt'}`, 'success');
                    
                    // G·ª≠i l·ªánh ƒë·∫øn ESP32
                    const command = enabled ? 'AUTO_MODE_ON' : 'AUTO_MODE_OFF';
                    await fetch('/api/esp32/command', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({command: command, value: ''})
                    });
                    
                } else {
                    // Rollback toggle
                    const toggle1 = document.getElementById('autoModeToggle');
                    const toggle2 = document.getElementById('autoModeToggle2');
                    if (toggle1) toggle1.checked = !enabled;
                    if (toggle2) toggle2.checked = !enabled;
                    showToast('‚ùå L·ªói', result.error || 'Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t ch·∫ø ƒë·ªô t·ª± ƒë·ªông', 'danger');
                }
            } catch (error) {
                console.error('‚ùå L·ªói c·∫≠p nh·∫≠t ch·∫ø ƒë·ªô t·ª± ƒë·ªông:', error);
                const toggle1 = document.getElementById('autoModeToggle');
                const toggle2 = document.getElementById('autoModeToggle2');
                if (toggle1) toggle1.checked = !enabled;
                if (toggle2) toggle2.checked = !enabled;
                showToast('‚ùå L·ªói', 'Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn server', 'danger');
            } finally {
                showLoading(false);
            }
        }

        // ========== H√ÄM L·∫§Y D·ªÆ LI·ªÜU T·ª™ API ==========
    async function fetchSensorData() {
        try {
            const response = await fetch('/get_sensor_data');
            const data = await response.json();
            
            if (data.sensors) {
                lastUpdateTime = new Date();
                updateSensorDisplays(data.sensors);
                updateEvaluation(data.evaluation);
                updateDeviceStatus(data.sensors);
                
                // C·∫≠p nh·∫≠t tr·∫°ng th√°i ESP32
                esp32Connected = data.esp32_connected;
                updateEsp32Status(data.esp32_connected);
                
                // Ki·ªÉm tra d·ªØ li·ªáu c≈©
                if (data.is_stale) {
                    showToast('‚ö†Ô∏è C·∫£nh b√°o', 'D·ªØ li·ªáu c√≥ th·ªÉ kh√¥ng c√≤n m·ªõi nh·∫•t', 'warning');
                }
                
                // C·∫≠p nh·∫≠t bi·ªÉu ƒë·ªì n·∫øu c√≥
                if (window.updateCharts && data.history) {
                    updateCharts(data);
                }
                
                return true;
            }
        } catch (error) {
            console.error('‚ùå L·ªói l·∫•y d·ªØ li·ªáu:', error);
            showToast('‚ùå L·ªói', 'Kh√¥ng th·ªÉ l·∫•y d·ªØ li·ªáu t·ª´ server', 'danger');
            updateEsp32Status(false);
        }
        return false;
    }
          function updateAutoModeUI(enabled) {
            const statusElement = document.getElementById('auto-mode-status');
            const controlNotice = document.getElementById('control-notice');
            
            if (statusElement) {
                statusElement.textContent = enabled ? 'ƒêANG B·∫¨T' : 'ƒêANG T·∫ÆT';
                statusElement.className = `badge ${enabled ? 'bg-success' : 'bg-secondary'} p-2`;
            }
            
            // C·∫≠p nh·∫≠t th√¥ng b√°o
            if (controlNotice) {
                if (enabled) {
                    controlNotice.innerHTML = `
                        <i class="fas fa-robot me-2 fs-4"></i>
                        <div>
                            <strong>Ch·∫ø ƒë·ªô t·ª± ƒë·ªông ƒëang b·∫≠t</strong>
                            <div class="small">H·ªá th·ªëng t·ª± ƒë·ªông ƒëi·ªÅu ch·ªânh thi·∫øt b·ªã d·ª±a tr√™n ng∆∞·ª°ng c√†i ƒë·∫∑t</div>
                        </div>
                    `;
                    controlNotice.className = 'alert alert-custom alert-warning d-flex align-items-center mb-3';
                } else {
                    controlNotice.innerHTML = `
                        <i class="fas fa-check-circle text-success me-2 fs-4"></i>
                        <div>
                            <strong>Ch·∫ø ƒë·ªô th·ªß c√¥ng ƒëang b·∫≠t</strong>
                            <div class="small">B·∫°n c√≥ th·ªÉ ƒëi·ªÅu khi·ªÉn thi·∫øt b·ªã th·ªß c√¥ng</div>
                        </div>
                    `;
                    controlNotice.className = 'alert alert-custom alert-success d-flex align-items-center mb-3';
                }
            }
            
            // C·∫≠p nh·∫≠t tr·∫°ng th√°i n√∫t ƒëi·ªÅu khi·ªÉn (tr·ª´ c·∫£nh b√°o)
            const controlButtons = document.querySelectorAll('.control-btn:not([data-device="canh_bao"])');
            controlButtons.forEach(btn => {
                if (enabled) {
                    btn.disabled = true;
                    btn.style.opacity = '0.6';
                    btn.style.cursor = 'not-allowed';
                } else {
                    btn.disabled = false;
                    btn.style.opacity = '1';
                    btn.style.cursor = 'pointer';
                }
            });
        }
        
        function updateChartVisibility(isBarChart) {
            const lineContainer = document.getElementById('lineChartContainer');
            const barContainer = document.getElementById('barChartContainer');
            const chartLabel = document.getElementById('chartLabel');
            
            if (lineContainer && barContainer && chartLabel) {
                if (isBarChart) {
                    lineContainer.style.display = 'none';
                    barContainer.style.display = 'block';
                    chartLabel.textContent = 'Bi·ªÉu ƒë·ªì c·ªôt';
                } else {
                    lineContainer.style.display = 'block';
                    barContainer.style.display = 'none';
                    chartLabel.textContent = 'Bi·ªÉu ƒë·ªì ƒë∆∞·ªùng';
                }
            }
        }
        
        // ========== H√ÄM TI·ªÜN √çCH ==========
        function updateRealTime() {
            const now = new Date();
            const timeElement = document.getElementById('current-time');
            if (timeElement) {
                timeElement.textContent = now.toLocaleTimeString('vi-VN');
            }
        }
        
        function showToast(title, message, type) {
            const toastId = 'toast-' + Date.now();
            const toastHtml = `
                <div id="${toastId}" class="toast align-items-center text-white bg-${type} border-0" role="alert">
                    <div class="d-flex">
                        <div class="toast-body">
                            <strong>${title}</strong><br>
                            <small>${message}</small>
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                    </div>
                </div>
            `;
            
            const container = document.createElement('div');
            container.className = 'toast-container position-fixed bottom-0 end-0 p-3';
            container.innerHTML = toastHtml;
            document.body.appendChild(container);
            
            const toastElement = document.getElementById(toastId);
            const toast = new bootstrap.Toast(toastElement, {
                delay: 3000
            });
            toast.show();
            
            toastElement.addEventListener('hidden.bs.toast', function() {
                container.remove();
            });
        }
        
        function showLoading(show) {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) {
                overlay.style.display = show ? 'flex' : 'none';
            }
        }
        
        // ========== KH·ªûI T·∫†O KHI TRANG LOAD XONG ==========
        document.addEventListener('DOMContentLoaded', function() {
        console.log('üöÄ CLASSGUARD Dashboard initialized');
        
        // C·∫≠p nh·∫≠t tr·∫°ng th√°i ESP32 ban ƒë·∫ßu
        updateEsp32Status(esp32Connected);
        
        // L·∫•y d·ªØ li·ªáu ngay l·∫ßn ƒë·∫ßu
        fetchSensorData();
        
        // Thi·∫øt l·∫≠p interval c·∫≠p nh·∫≠t d·ªØ li·ªáu (m·ªói 2 gi√¢y)
        refreshInterval = setInterval(fetchSensorData, 2000);
        
        // Sync c·∫£ hai toggle auto mode
        const autoToggle1 = document.getElementById('autoModeToggle');
        const autoToggle2 = document.getElementById('autoModeToggle2');
        
        if (autoToggle1 && autoToggle2) {
            autoToggle1.addEventListener('change', function() {
                autoToggle2.checked = this.checked;
                updateAutoMode(this.checked);
            });
            
            autoToggle2.addEventListener('change', function() {
                autoToggle1.checked = this.checked;
                updateAutoMode(this.checked);
            });
        }
        
        // Chuy·ªÉn ƒë·ªïi bi·ªÉu ƒë·ªì
        const chartToggle = document.getElementById('chartToggle');
        if (chartToggle) {
            chartToggle.addEventListener('change', function() {
                console.log('üìà Chuy·ªÉn ƒë·ªïi bi·ªÉu ƒë·ªì:', this.checked);
                updateChartVisibility(this.checked);
            });
        }
        
        // N√∫t l√†m m·ªõi bi·ªÉu ƒë·ªì
        const refreshBtn = document.getElementById('refreshCharts');
        if (refreshBtn) {
            refreshBtn.addEventListener('click', function() {
                console.log('üîÑ L√†m m·ªõi d·ªØ li·ªáu');
                fetchSensorData();
                showToast('‚ÑπÔ∏è Th√¥ng b√°o', 'ƒêang l√†m m·ªõi d·ªØ li·ªáu...', 'info');
            });
        }
        
        // N√∫t ƒëi·ªÅu khi·ªÉn thi·∫øt b·ªã
        document.querySelectorAll('.control-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const device = this.dataset.device;
                const action = this.dataset.action;
                console.log(`üéÆ Click n√∫t ƒëi·ªÅu khi·ªÉn: ${device} -> ${action}`);
                
                if (device && action) {
                    controlDevice(device, action);
                }
            });
        });
        
        // Ki·ªÉm tra c·∫≠p nh·∫≠t ƒë·ªãnh k·ª≥
        setInterval(() => {
            if (lastUpdateTime) {
                const diff = (new Date() - lastUpdateTime) / 1000;
                if (diff > 60) { // 60 gi√¢y kh√¥ng c·∫≠p nh·∫≠t
                    updateEsp32Status(false);
                    const indicator = document.getElementById('realtime-indicator');
                    if (indicator) {
                        indicator.classList.add('offline');
                    }
                }
            }
        }, 10000); // Ki·ªÉm tra m·ªói 10 gi√¢y
        
        console.log('‚úÖ CLASSGUARD Dashboard ready');
    });
    
    // D·ªçn d·∫πp khi trang ƒë√≥ng
    window.addEventListener('beforeunload', function() {
        if (refreshInterval) {
            clearInterval(refreshInterval);
        }
    });
</script>
</body>
</html>

