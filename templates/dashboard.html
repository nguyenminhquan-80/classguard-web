<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CLASSGUARD - B·∫£ng ƒëi·ªÅu khi·ªÉn</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #4361ee;
            --secondary: #3a0ca3;
            --success: #28a745;
            --warning: #ffc107;
            --danger: #dc3545;
            --info: #17a2b8;
            --light: #f8f9fa;
            --dark: #343a40;
        }
        
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #e4e8f0 100%);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100vh;
        }
        
        /* ====== FIX CHART CONTAINERS ====== */
        .chart-container {
            height: 300px !important;
            min-height: 300px !important;
            max-height: 300px !important;
            position: relative;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        /* ƒê·∫£m b·∫£o chart canvas kh√¥ng ph√¨nh to */
        .chart-container canvas {
            width: 100% !important;
            height: 300px !important;
            max-height: 300px !important;
        }

        /* Hi·ªáu ·ª©ng c·ª≠a */
        .door-open {
            color: #28a745 !important;
            animation: doorOpen 0.5s ease;
        }
        
        .door-closed {
            color: #dc3545 !important;
            animation: doorClose 0.5s ease;
        }
        
        @keyframes doorOpen {
            0% { transform: rotateY(0deg); }
            100% { transform: rotateY(-20deg); }
        }
        
        @keyframes doorClose {
            0% { transform: rotateY(-20deg); }
            100% { transform: rotateY(0deg); }
        }

        /* Animation cho qu·∫°t */
        .fa-fan.fa-spin {
            animation: fa-spin 1.5s infinite linear;
        }

        /* Animation cho chu√¥ng c·∫£nh b√°o */
        @keyframes bell-shake {
            0% { transform: rotate(0deg); }
            25% { transform: rotate(-15deg); }
            75% { transform: rotate(15deg); }
            100% { transform: rotate(0deg); }
        }

        .fa-bell.fa-shake {
            animation: bell-shake 0.5s infinite;
        }

        /* Chart toggle button */
        .form-switch .form-check-input {
            width: 50px;
            height: 26px;
            cursor: pointer;
        }

        .form-switch .form-check-input:checked {
            background-color: #4361ee;
            border-color: #4361ee;
        }

        .form-switch .form-check-input:focus {
            box-shadow: 0 0 0 0.25rem rgba(67, 97, 238, 0.25);
        }

        /* Responsive cho mobile */
        @media (max-width: 992px) {
            .chart-container {
                height: 260px !important;
                min-height: 260px !important;
                max-height: 260px !important;
            }
            
            .chart-container canvas {
                height: 260px !important;
                max-height: 260px !important;
            }
        }

        @media (max-width: 768px) {
            .chart-container {
                height: 240px !important;
                min-height: 240px !important;
                max-height: 240px !important;
            }
            
            .chart-container canvas {
                height: 240px !important;
                max-height: 240px !important;
            }
            
            .section-header {
                flex-direction: column;
                align-items: flex-start !important;
                gap: 10px;
            }
            
            .section-header h2 {
                margin-bottom: 0;
            }
        }

        /* ƒê·∫£m b·∫£o charts section kh√¥ng b·ªã ph√¨nh */
        .charts-section {
            overflow: hidden;
            padding-bottom: 10px;
        }

        /* Chart labels nh·ªè g·ªçn */
        #chartLabel {
            font-weight: 600;
            color: #4361ee;
        }
        
        /* Main Container */
        .main-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        /* Header v·ªõi Navigation */
        .dashboard-header {
            background: white;
            border-radius: 15px;
            padding: 15px 25px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            margin-bottom: 25px;
            border-left: 5px solid var(--primary);
        }
        
        .logo-area {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .logo-icon {
            font-size: 2.2rem;
            color: var(--primary);
            background: linear-gradient(135deg, #4361ee 0%, #3a0ca3 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .logo-text {
            font-size: 1.8rem;
            font-weight: 800;
            color: var(--primary);
            margin: 0;
        }
        
        .logo-subtext {
            font-size: 0.85rem;
            color: #6c757d;
            margin: 0;
        }
        
        /* Navigation Menu */
        .nav-menu {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .nav-btn {
            padding: 10px 20px;
            border-radius: 10px;
            font-weight: 600;
            font-size: 0.95rem;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
        }
        
        .nav-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .nav-btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            border: none;
        }
        
        .nav-btn-outline {
            background: white;
            color: var(--primary);
            border: 2px solid var(--primary);
        }
        
        .nav-btn-success {
            background: var(--success);
            color: white;
            border: none;
        }
        
        .nav-btn-warning {
            background: var(--warning);
            color: var(--dark);
            border: none;
        }
        
        /* User Info */
        .user-info {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 20px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }
        
        .user-avatar {
            width: 45px;
            height: 45px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }
        
        .user-details {
            flex-grow: 1;
        }
        
        .user-name {
            font-weight: 600;
            margin: 0;
            font-size: 1.1rem;
        }
        
        .user-role {
            font-size: 0.85rem;
            opacity: 0.9;
            margin: 2px 0 0 0;
        }
        
        .login-time {
            font-size: 0.75rem;
            opacity: 0.8;
            margin: 3px 0 0 0;
        }
        
        /* Time Display */
        .time-display {
            text-align: center;
            padding: 10px 15px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
        }
        
        .current-time {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--primary);
            margin: 0;
        }
        
        .time-label {
            font-size: 0.85rem;
            color: #6c757d;
            margin: 0;
        }
        
        /* Sensor Cards Grid */
        .sensor-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .sensor-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            border: 3px solid transparent;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .sensor-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: currentColor;
            opacity: 0.3;
        }
        
        .sensor-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.12);
        }
        
        .sensor-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
        }
        
        .sensor-icon {
            font-size: 1.8rem;
            opacity: 0.9;
        }
        
        .sensor-value {
            font-size: 2.2rem;
            font-weight: 800;
            margin: 10px 0;
            font-family: 'Segoe UI', Arial, sans-serif;
        }
        
        .sensor-unit {
            font-size: 0.9rem;
            color: #6c757d;
            font-weight: 500;
        }
        
        .sensor-status {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            margin-top: 10px;
        }
        
        /* Charts Section */
        .charts-section {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            margin-bottom: 25px;
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .section-title {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--dark);
            margin: 0;
        }
        
        /* Control Panel */
        .control-panel {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            margin-bottom: 25px;
        }
        
        .device-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }
        
        .device-card {
            background: var(--light);
            border-radius: 12px;
            padding: 20px;
            border: 2px solid #e9ecef;
            transition: all 0.3s;
        }
        
        .device-card:hover {
            border-color: var(--primary);
            background: white;
        }
        
        .device-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .device-icon-wrapper {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            background: rgba(67, 97, 238, 0.1);
            color: var(--primary);
        }
        
        .device-info h5 {
            margin: 0;
            font-weight: 700;
            font-size: 1.1rem;
        }
        
        .device-info p {
            margin: 5px 0 0 0;
            font-size: 0.85rem;
            color: #6c757d;
        }
        
        .control-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .control-btn {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.95rem;
            transition: all 0.3s;
            cursor: pointer;
        }
        
        .control-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        .control-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .btn-on {
            background: linear-gradient(135deg, var(--success) 0%, #20c997 100%);
            color: white;
        }
        
        .btn-off {
            background: linear-gradient(135deg, var(--danger) 0%, #e83e8c 100%);
            color: white;
        }
        
        .btn-on.active {
            box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.3);
        }
        
        .btn-off.active {
            box-shadow: 0 0 0 3px rgba(220, 53, 69, 0.3);
        }
        
        .device-status {
            text-align: center;
            margin-top: 10px;
        }
        
        .status-badge {
            display: inline-block;
            padding: 6px 15px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        .status-on {
            background: rgba(40, 167, 69, 0.15);
            color: var(--success);
        }
        
        .status-off {
            background: rgba(108, 117, 125, 0.15);
            color: #6c757d;
        }

        /* Auto Mode Card */
        .auto-mode-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
        }
        
        .auto-mode-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .auto-mode-icon {
            font-size: 1.8rem;
        }
        
        .form-switch-xl .form-check-input {
            width: 60px;
            height: 30px;
            margin-top: 0;
        }
        
        /* Evaluation Section */
        .evaluation-section {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
        }
        
        .evaluation-header {
            text-align: center;
            margin-bottom: 25px;
        }
        
        .overall-score {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            font-size: 2.2rem;
            font-weight: 800;
            color: white;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }
        
        .score-success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }
        
        .score-warning {
            background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%);
        }
        
        .score-danger {
            background: linear-gradient(135deg, #dc3545 0%, #e83e8c 100%);
        }
        
        .progress-container {
            margin: 25px 0;
        }
        
        .progress {
            height: 25px;
            border-radius: 12px;
            background: #e9ecef;
            overflow: hidden;
        }
        
        .progress-bar {
            border-radius: 12px;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: width 1s ease-in-out;
        }
        
        .evaluation-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .eval-item {
            background: var(--light);
            border-radius: 10px;
            padding: 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .eval-label {
            font-weight: 600;
            color: var(--dark);
        }
        
        .eval-value {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
        }
        
        /* Footer */
        .dashboard-footer {
            text-align: center;
            padding: 20px;
            color: #6c757d;
            font-size: 0.9rem;
            margin-top: 30px;
        }
        
        .footer-links {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 10px;
        }
        
        .footer-link {
            color: var(--primary);
            text-decoration: none;
            transition: color 0.3s;
        }
        
        .footer-link:hover {
            color: var(--secondary);
        }
        
        /* Responsive */
        @media (max-width: 1200px) {
            .sensor-grid {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            }
        }
        
        @media (max-width: 992px) {
            .dashboard-header {
                flex-direction: column;
                gap: 15px;
            }
            
            .nav-menu {
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .sensor-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 768px) {
            .main-container {
                padding: 15px;
            }
            
            .sensor-grid {
                grid-template-columns: 1fr;
            }
            
            .device-grid {
                grid-template-columns: 1fr;
            }
            
            .evaluation-grid {
                grid-template-columns: 1fr;
            }
            
            .nav-btn {
                padding: 8px 15px;
                font-size: 0.9rem;
            }
            
            .sensor-value {
                font-size: 1.8rem;
            }
        }
        
        /* Animations */
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .pulse {
            animation: pulse 2s infinite;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--secondary);
        }
        
        /* Toast Notification */
        .toast-container {
            z-index: 9999;
        }
        
        /* Connection Status */
        .connection-status {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            font-size: 0.85rem;
        }
        
        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
        }
        
        .status-online {
            background-color: #28a745;
            animation: pulse 2s infinite;
        }
        
        .status-offline {
            background-color: #dc3545;
        }
        
        .status-idle {
            background-color: #ffc107;
        }
    </style>
</head>
<body>
    <div class="main-container">
        <!-- Header v·ªõi Navigation -->
        <div class="dashboard-header d-flex justify-content-between align-items-center flex-wrap gap-3">
            <div class="logo-area">
                <div>
                    <i class="fas fa-school logo-icon"></i>
                </div>
                <div>
                    <h1 class="logo-text">CLASSGUARD</h1>
                    <p class="logo-subtext">H·ªá th·ªëng gi√°m s√°t m√¥i tr∆∞·ªùng l·ªõp h·ªçc th√¥ng minh</p>
                    <p class="logo-subtext">M√£ d·ª± √°n: 19016</p>
                </div>
            </div>
            
            <div class="nav-menu">
                <a href="/dashboard" class="nav-btn nav-btn-primary">
                    <i class="fas fa-tachometer-alt"></i>
                    <span>Dashboard</span>
                </a>
                
                {% if role in ['admin', 'teacher'] %}
                <a href="/data" class="nav-btn nav-btn-outline">
                    <i class="fas fa-database"></i>
                    <span>D·ªØ li·ªáu</span>
                </a>
                {% endif %}
                
                {% if role == 'admin' %}
                <a href="/settings" class="nav-btn nav-btn-warning">
                    <i class="fas fa-cog"></i>
                    <span>C√†i ƒë·∫∑t</span>
                </a>
                {% endif %}
                
                <a href="/export_csv" class="nav-btn nav-btn-success">
                    <i class="fas fa-file-export"></i>
                    <span>Xu·∫•t b√°o c√°o</span>
                </a>
            </div>
            
            <div class="d-flex align-items-center gap-3">
                <div class="time-display">
                    <p class="current-time" id="current-time">--:--:--</p>
                    <p class="time-label">Th·ªùi gian hi·ªán t·∫°i</p>
                </div>
                
                <div class="user-info">
                    <div class="user-avatar">
                        <i class="fas fa-user-circle"></i>
                    </div>
                    <div class="user-details">
                        <h3 class="user-name">{{ name }}</h3>
                        <p class="user-role">
                            <span class="badge bg-{{ 'danger' if role == 'admin' else 'warning' if role == 'teacher' else 'info' if role == 'student' else 'secondary' }}">
                                {{ 'Qu·∫£n tr·ªã vi√™n' if role == 'admin' else 'Gi√°o vi√™n' if role == 'teacher' else 'H·ªçc sinh' if role == 'student' else 'Kh√°ch xem' }}
                            </span>
                        </p>
                        <p class="login-time">
                            <i class="fas fa-clock me-1"></i>
                            {{ login_time }}
                        </p>
                    </div>
                    <a href="/logout" class="btn btn-sm btn-light">
                        <i class="fas fa-sign-out-alt"></i>
                    </a>
                </div>
            </div>
        </div>

        <!-- Alert Container -->
        <div id="alert-container" class="mb-3"></div>

        <!-- Connection Status -->
        <div class="alert alert-info d-flex align-items-center justify-content-between mb-3" id="connection-status">
            <div class="d-flex align-items-center">
                <div class="status-dot status-online me-2"></div>
                <div>
                    <strong>K·∫øt n·ªëi h·ªá th·ªëng</strong>
                    <div class="small" id="connection-details">
                        <span id="device-status">{{ 'ƒêang k·∫øt n·ªëi ESP32' if data.device_status == 'online' else 'S·ª≠ d·ª•ng d·ªØ li·ªáu demo' }}</span>
                        <span id="last-update-detail"> ‚Ä¢ C·∫≠p nh·∫≠t: <span id="last-update-time">{{ data.timestamp if data.timestamp else '--:--:--' }}</span></span>
                    </div>
                </div>
            </div>
            <div class="connection-status">
                <span id="cache-status">ƒê·ªìng b·ªô: <span id="sync-status">Kh·ªüi t·∫°o...</span></span>
            </div>
        </div>

        <!-- Auto Mode Notice -->
        <div id="control-notice" class="alert alert-warning d-flex align-items-center mb-3">
            <i class="fas fa-robot me-2 fs-4"></i>
            <div>
                <strong>Ch·∫ø ƒë·ªô t·ª± ƒë·ªông ƒëang b·∫≠t</strong>
                <div class="small">H·ªá th·ªëng t·ª± ƒë·ªông ƒëi·ªÅu ch·ªânh thi·∫øt b·ªã (tr·ª´ c·∫£nh b√°o)</div>
            </div>
        </div>

        <!-- Sensor Cards -->
        <div class="sensor-grid fade-in">
            <!-- Nhi·ªát ƒë·ªô -->
            <div class="sensor-card border-warning" id="temp-card">
                <div class="sensor-header">
                    <div>
                        <h5 class="fw-bold mb-1">üå°Ô∏è Nhi·ªát ƒë·ªô</h5>
                        <p class="text-muted small mb-0">ƒê·ªô Celsius</p>
                    </div>
                    <i class="fas fa-thermometer-half sensor-icon text-warning"></i>
                </div>
                <div class="sensor-value text-warning" id="temp-value">{{ data.nhiet_do|round(1) }}</div>
                <div class="sensor-unit">¬∞C</div>
                <div class="mt-3">
                    <span class="sensor-status bg-{{ 'danger' if data.nhiet_do > 32 else 'warning' if data.nhiet_do > 28 else 'success' }} text-white">
                        {{ 'N√≥ng' if data.nhiet_do > 32 else '·∫§m' if data.nhiet_do > 28 else 'T·ªët' }}
                    </span>
                </div>
                <div class="mt-2 small text-muted">
                    Ng∆∞·ª°ng: {{ settings.temp_min|round(1) }}¬∞C - {{ settings.temp_max|round(1) }}¬∞C
                </div>
            </div>

            <!-- ƒê·ªô ·∫©m -->
            <div class="sensor-card border-info" id="hum-card">
                <div class="sensor-header">
                    <div>
                        <h5 class="fw-bold mb-1">üíß ƒê·ªô ·∫©m</h5>
                        <p class="text-muted small mb-0">ƒê·ªô ·∫©m kh√¥ng kh√≠</p>
                    </div>
                    <i class="fas fa-tint sensor-icon text-info"></i>
                </div>
                <div class="sensor-value text-info" id="hum-value">{{ data.do_am|round(1) }}</div>
                <div class="sensor-unit">%</div>
                <div class="mt-3">
                    <span class="sensor-status bg-{{ 'warning' if data.do_am < 40 or data.do_am > 70 else 'success' }} text-white">
                        {{ 'Kh√¥' if data.do_am < 40 else '·∫®m' if data.do_am > 70 else 'T·ªët' }}
                    </span>
                </div>
                <div class="mt-2 small text-muted">
                    L√Ω t∆∞·ªüng: 40% - 70%
                </div>
            </div>

            <!-- √Ånh s√°ng -->
            <div class="sensor-card border-warning" id="light-card">
                <div class="sensor-header">
                    <div>
                        <h5 class="fw-bold mb-1">‚òÄÔ∏è √Ånh s√°ng</h5>
                        <p class="text-muted small mb-0">C∆∞·ªùng ƒë·ªô √°nh s√°ng</p>
                    </div>
                    <i class="fas fa-sun sensor-icon text-warning"></i>
                </div>
                <div class="sensor-value text-warning" id="light-value">{{ data.anh_sang|round }}</div>
                <div class="sensor-unit">lux</div>
                <div class="mt-3">
                    <span class="sensor-status bg-{{ 'danger' if data.anh_sang < 200 else 'warning' if data.anh_sang < 300 else 'success' }} text-white">
                        {{ 'T·ªëi' if data.anh_sang < 200 else 'V·ª´a' if data.anh_sang < 300 else 'S√°ng' }}
                    </span>
                </div>
                <div class="mt-2 small text-muted">
                    T·ªëi thi·ªÉu: {{ settings.light_min|round }} lux
                </div>
            </div>

            <!-- Ch·∫•t l∆∞·ª£ng kh√¥ng kh√≠ -->
            <div class="sensor-card border-success" id="air-card">
                <div class="sensor-header">
                    <div>
                        <h5 class="fw-bold mb-1">üí® Ch·∫•t l∆∞·ª£ng KK</h5>
                        <p class="text-muted small mb-0">N·ªìng ƒë·ªô CO2</p>
                    </div>
                    <i class="fas fa-wind sensor-icon text-success"></i>
                </div>
                <div class="sensor-value text-success" id="air-value">{{ data.chat_luong_kk|round }}</div>
                <div class="sensor-unit">PPM</div>
                <div class="mt-3">
                    <span class="sensor-status bg-{{ 'danger' if data.chat_luong_kk > 800 else 'warning' if data.chat_luong_kk > 400 else 'success' }} text-white">
                        {{ '√î nhi·ªÖm' if data.chat_luong_kk > 800 else 'Trung b√¨nh' if data.chat_luong_kk > 400 else 'T·ªët' }}
                    </span>
                </div>
                <div class="mt-2 small text-muted">
                    T·ªëi ƒëa: {{ settings.air_max }} PPM
                </div>
            </div>

            <!-- ƒê·ªô ·ªìn -->
            <div class="sensor-card border-danger" id="noise-card">
                <div class="sensor-header">
                    <div>
                        <h5 class="fw-bold mb-1">üîä ƒê·ªô ·ªìn</h5>
                        <p class="text-muted small mb-0">M·ª©c √¢m thanh</p>
                    </div>
                    <i class="fas fa-volume-up sensor-icon text-danger"></i>
                </div>
                <div class="sensor-value text-danger" id="noise-value">{{ data.do_on|round }}</div>
                <div class="sensor-unit">dB</div>
                <div class="mt-3">
                    <span class="sensor-status bg-{{ 'danger' if data.do_on > 70 else 'warning' if data.do_on > 50 else 'success' }} text-white">
                        {{ '·ªín' if data.do_on > 70 else 'B√¨nh th∆∞·ªùng' if data.do_on > 50 else 'Y√™n tƒ©nh' }}
                    </span>
                </div>
                <div class="mt-2 small text-muted">
                    T·ªëi ƒëa: {{ settings.noise_max }} dB
                </div>
            </div>
        </div>

        <!-- Charts Section -->
        <div class="charts-section fade-in">
            <div class="section-header">
                <h2 class="section-title">
                    <i class="fas fa-chart-line me-2"></i>Bi·ªÉu ƒë·ªì d·ªØ li·ªáu
                </h2>
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="chartToggle" style="width: 60px; height: 30px;">
                    <label class="form-check-label fw-bold" for="chartToggle">
                        <span id="chartLabel">Bi·ªÉu ƒë·ªì ƒë∆∞·ªùng</span>
                    </label>
                </div>
            </div>
            
            <div class="chart-container">
                <div id="lineChartContainer">
                    <canvas id="lineChart"></canvas>
                </div>
                <div id="barChartContainer" style="display: none;">
                    <canvas id="barChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Control Panel -->
        <div class="control-panel fade-in">
            <div class="section-header mb-4">
                <h2 class="section-title">
                    <i class="fas fa-gamepad me-2"></i>ƒêi·ªÅu khi·ªÉn thi·∫øt b·ªã
                </h2>
                <div class="d-flex align-items-center gap-3">
                    <span class="badge bg-{{ 'success' if settings.auto_mode else 'secondary' }} p-2" id="auto-mode-status">
                        {{ 'ƒêANG B·∫¨T' if settings.auto_mode else 'ƒêANG T·∫ÆT' }}
                    </span>
                    <div class="form-check form-switch form-switch-xl">
                        <input class="form-check-input" type="checkbox" id="autoModeToggle" 
                               {% if settings.auto_mode %}checked{% endif %}>
                        <label class="form-check-label fw-bold" for="autoModeToggle">
                            Ch·∫ø ƒë·ªô t·ª± ƒë·ªông
                        </label>
                    </div>
                </div>
            </div>
            
            {% if role in ['admin', 'teacher'] %}
            <div class="device-grid">
                <!-- Qu·∫°t -->
                <div class="device-card">
                    <div class="device-header">
                        <div class="device-icon-wrapper">
                            <i class="fas fa-fan" id="quat-icon"></i>
                        </div>
                        <div class="device-info">
                            <h5>üåÄ Qu·∫°t l√†m m√°t</h5>
                            <p>ƒêi·ªÅu ch·ªânh nhi·ªát ƒë·ªô ph√≤ng</p>
                        </div>
                    </div>
                    
                    <div class="control-buttons">
                        <button class="control-btn btn-on {{ 'active' if data.quat == 'B·∫¨T' else '' }}" 
                                data-device="quat" 
                                data-action="B·∫¨T"
                                id="quat-on-btn">
                            <i class="fas fa-play me-1"></i> B·∫¨T
                        </button>
                        <button class="control-btn btn-off {{ 'active' if data.quat == 'T·∫ÆT' else '' }}" 
                                data-device="quat" 
                                data-action="T·∫ÆT"
                                id="quat-off-btn">
                            <i class="fas fa-stop me-1"></i> T·∫ÆT
                        </button>
                    </div>
                    
                    <div class="device-status">
                        <span class="status-badge status-{{ 'on' if data.quat == 'B·∫¨T' else 'off' }}" id="quat-status">
                            {{ data.quat }}
                        </span>
                    </div>
                </div>

                <!-- ƒê√®n -->
                <div class="device-card">
                    <div class="device-header">
                        <div class="device-icon-wrapper">
                            <i class="fas fa-lightbulb" id="den-icon"></i>
                        </div>
                        <div class="device-info">
                            <h5>üí° ƒê√®n chi·∫øu s√°ng</h5>
                            <p>ƒêi·ªÅu ch·ªânh √°nh s√°ng l·ªõp h·ªçc</p>
                        </div>
                    </div>
                    
                    <div class="control-buttons">
                        <button class="control-btn btn-on {{ 'active' if data.den == 'B·∫¨T' else '' }}" 
                                data-device="den" 
                                data-action="B·∫¨T"
                                id="den-on-btn">
                            <i class="fas fa-lightbulb me-1"></i> B·∫¨T
                        </button>
                        <button class="control-btn btn-off {{ 'active' if data.den == 'T·∫ÆT' else '' }}" 
                                data-device="den" 
                                data-action="T·∫ÆT"
                                id="den-off-btn">
                            <i class="fas fa-lightbulb me-1"></i> T·∫ÆT
                        </button>
                    </div>
                    
                    <div class="device-status">
                        <span class="status-badge status-{{ 'on' if data.den == 'B·∫¨T' else 'off' }}" id="den-status">
                            {{ data.den }}
                        </span>
                    </div>
                </div>

                <!-- C·ª≠a s·ªï -->
                <div class="device-card">
                    <div class="device-header">
                        <div class="device-icon-wrapper">
                            <i class="fas fa-door-closed" id="cua_so-icon"></i>
                        </div>
                        <div class="device-info">
                            <h5>üö™ C·ª≠a s·ªï</h5>
                            <p>Th√¥ng tho√°ng kh√¥ng kh√≠</p>
                        </div>
                    </div>
                    
                    <div class="control-buttons">
                        <button class="control-btn btn-on {{ 'active' if data.cua_so == 'M·ªû' else '' }}" 
                                data-device="cua_so" 
                                data-action="M·ªû"
                                id="cua_so-on-btn">
                            <i class="fas fa-door-open me-1"></i> M·ªû
                        </button>
                        <button class="control-btn btn-off {{ 'active' if data.cua_so == 'ƒê√ìNG' else '' }}" 
                                data-device="cua_so" 
                                data-action="ƒê√ìNG"
                                id="cua_so-off-btn">
                            <i class="fas fa-door-closed me-1"></i> ƒê√ìNG
                        </button>
                    </div>
                    
                    <div class="device-status">
                        <span class="status-badge status-{{ 'on' if data.cua_so == 'M·ªû' else 'off' }}" id="cua_so-status">
                            {{ data.cua_so }}
                        </span>
                    </div>
                </div>

                <!-- C·∫£nh b√°o -->
                <div class="device-card">
                    <div class="device-header">
                        <div class="device-icon-wrapper">
                            <i class="fas fa-bell" id="canh_bao-icon"></i>
                        </div>
                        <div class="device-info">
                            <h5>‚ö†Ô∏è H·ªá th·ªëng c·∫£nh b√°o</h5>
                            <p>B√°o ƒë·ªông khi c√≥ v·∫•n ƒë·ªÅ</p>
                        </div>
                    </div>
                    
                    <div class="control-buttons">
                        <button class="control-btn btn-on {{ 'active' if data.canh_bao == 'B·∫¨T' else '' }}" 
                                data-device="canh_bao" 
                                data-action="B·∫¨T"
                                id="canh_bao-on-btn">
                            <i class="fas fa-bell me-1"></i> B·∫¨T
                        </button>
                        <button class="control-btn btn-off {{ 'active' if data.canh_bao == 'T·∫ÆT' else '' }}" 
                                data-device="canh_bao" 
                                data-action="T·∫ÆT"
                                id="canh_bao-off-btn">
                            <i class="fas fa-bell-slash me-1"></i> T·∫ÆT
                        </button>
                    </div>
                    
                    <div class="device-status">
                        <span class="status-badge status-{{ 'on' if data.canh_bao == 'B·∫¨T' else 'off' }}" id="canh_bao-status">
                            {{ data.canh_bao }}
                        </span>
                        <div class="mt-1 small text-muted">
                            <i class="fas fa-info-circle"></i> Lu√¥n ƒëi·ªÅu khi·ªÉn ƒë∆∞·ª£c
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="auto-mode-card mt-4">
                <div class="auto-mode-header">
                    <i class="fas fa-robot auto-mode-icon"></i>
                    <div class="flex-grow-1">
                        <h4 class="mb-1">ü§ñ Ch·∫ø ƒë·ªô t·ª± ƒë·ªông th√¥ng minh</h4>
                        <p class="mb-0 small opacity-90">H·ªá th·ªëng t·ª± ƒë·ªông ƒëi·ªÅu khi·ªÉn thi·∫øt b·ªã d·ª±a tr√™n ng∆∞·ª°ng c√†i ƒë·∫∑t</p>
                    </div>
                    <div class="form-check form-switch form-switch-xl">
                        <input class="form-check-input" type="checkbox" id="autoModeToggle2" 
                               {% if settings.auto_mode %}checked{% endif %}>
                    </div>
                </div>
                <div class="mt-3">
                    <div class="row g-2">
                        <div class="col-md-3">
                            <div class="text-center p-2 bg-white bg-opacity-10 rounded">
                                <div class="small">üå°Ô∏è Nhi·ªát ƒë·ªô</div>
                                <div class="fw-bold">{{ settings.temp_min }}¬∞C - {{ settings.temp_max }}¬∞C</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center p-2 bg-white bg-opacity-10 rounded">
                                <div class="small">‚òÄÔ∏è √Ånh s√°ng</div>
                                <div class="fw-bold">{{ settings.light_min }}+ lux</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center p-2 bg-white bg-opacity-10 rounded">
                                <div class="small">üí® Ch·∫•t l∆∞·ª£ng KK</div>
                                <div class="fw-bold">{{ settings.air_max }} PPM</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center p-2 bg-white bg-opacity-10 rounded">
                                <div class="small">üîä ƒê·ªô ·ªìn</div>
                                <div class="fw-bold">{{ settings.noise_max }} dB</div>
                            </div>
                        </div>
                    </div>
                    <div class="mt-3 small opacity-80">
                        <i class="fas fa-info-circle me-1"></i> C·∫£nh b√°o lu√¥n ƒëi·ªÅu khi·ªÉn ƒë∆∞·ª£c b·∫•t k·ªÉ ch·∫ø ƒë·ªô
                    </div>
                </div>
            </div>
            
            {% else %}
            <div class="alert alert-info d-flex align-items-center">
                <i class="fas fa-info-circle fs-4 me-3"></i>
                <div>
                    <h5 class="mb-2">Ch·ªâ d√†nh cho gi√°o vi√™n v√† qu·∫£n tr·ªã vi√™n</h5>
                    <p class="mb-0">B·∫°n kh√¥ng c√≥ quy·ªÅn ƒëi·ªÅu khi·ªÉn thi·∫øt b·ªã. Vui l√≤ng li√™n h·ªá qu·∫£n tr·ªã vi√™n n·∫øu c·∫ßn thi·∫øt.</p>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Evaluation Section -->
        <div class="evaluation-section fade-in">
            <div class="evaluation-header">
                <div class="overall-score score-{{ evaluation.overall_class }}" id="score-value">
                    {{ evaluation.total_score }}/10
                </div>
                <h2 class="mt-3" id="overall-evaluation">{{ evaluation.overall }}</h2>
                <p class="text-muted mb-0" id="class-eval">{{ evaluation.class_eval }}</p>
            </div>
            
            <div class="progress-container">
                <div class="d-flex justify-content-between mb-2">
                    <span>ƒêi·ªÉm ƒë√°nh gi√° m√¥i tr∆∞·ªùng</span>
                    <span class="fw-bold">{{ evaluation.percentage }}%</span>
                </div>
                <div class="progress">
                    <div class="progress-bar bg-{{ evaluation.overall_class }}" 
                         id="score-progress" style="width: {{ evaluation.percentage }}%">
                        {{ evaluation.percentage }}%
                    </div>
                </div>
            </div>
            
            <div class="alert alert-{{ evaluation.overall_class }} d-flex align-items-center mt-4">
                <i class="fas fa-comment-medical fs-4 me-3"></i>
                <div>
                    <h5 class="mb-1">Khuy·∫øn ngh·ªã</h5>
                    <p class="mb-0" id="advice-text">{{ evaluation.advice }}</p>
                </div>
            </div>
            
            <h5 class="mt-4 mb-3">ƒê√°nh gi√° chi ti·∫øt:</h5>
            <div class="evaluation-grid" id="evaluation-details">
                {% for item in evaluation.evaluations %}
                <div class="eval-item">
                    <span class="eval-label">{{ item[0] }}</span>
                    <span class="eval-value bg-{{ item[2] }} text-white">{{ item[1] }}</span>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Footer -->
        <div class="dashboard-footer">
            <p class="mb-2">
                <strong>CLASSGUARD</strong> - H·ªá th·ªëng gi√°m s√°t m√¥i tr∆∞·ªùng l·ªõp h·ªçc th√¥ng minh - M√£ d·ª± √°n: 19016
            </p>
            <p class="small text-muted mb-3">
                <i class="fas fa-sync-alt"></i> D·ªØ li·ªáu c·∫≠p nh·∫≠t m·ªói 800ms | 
                <i class="fas fa-shield-alt"></i> Phi√™n b·∫£n 4.0 | 
                <i class="fas fa-heart text-danger"></i> D·ª± √°n Khoa h·ªçc K·ªπ thu·∫≠t - THCS
            </p>
            <div class="footer-links">
                <a href="#" class="footer-link"><i class="fas fa-question-circle me-1"></i> Tr·ª£ gi√∫p</a>
                <a href="#" class="footer-link"><i class="fas fa-info-circle me-1"></i> Gi·ªõi thi·ªáu</a>
                <a href="#" class="footer-link"><i class="fas fa-envelope me-1"></i> Li√™n h·ªá</a>
                <a href="#" class="footer-link"><i class="fas fa-shield-alt me-1"></i> B·∫£o m·∫≠t</a>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
    
    <!-- Dashboard JavaScript -->
    <script>
        // ========== BI·∫æN TO√ÄN C·ª§C ==========
        let isAutoMode = {{ 'true' if settings.auto_mode else 'false' }};
        let syncInterval = null;
        let updateInterval = null;
        let lastUpdateTime = Date.now();
        
        // ========== KH·ªûI T·∫†O DASHBOARD ==========
        function initDashboard() {
            console.log('üöÄ Kh·ªüi t·∫°o CLASSGUARD Dashboard...');
            
            // Kh·ªüi t·∫°o bi·ªÉu ƒë·ªì
            setTimeout(initCharts, 100);
            
            // ƒê·ªìng b·ªô m·ªói 800ms
            syncInterval = setInterval(syncDashboard, 800);
            
            // C·∫≠p nh·∫≠t d·ªØ li·ªáu m·ªói 1 gi√¢y
            updateInterval = setInterval(updateDashboard, 1000);
            
            // C·∫≠p nh·∫≠t th·ªùi gian
            setInterval(updateRealTime, 1000);
            
            // Kh·ªüi t·∫°o event listeners
            initEventListeners();
            
            // C·∫≠p nh·∫≠t UI ban ƒë·∫ßu
            updateAutoModeUI(isAutoMode);
            updateControlButtonsState(!isAutoMode);
            
            // Hi·ªÉn th·ªã tr·∫°ng th√°i k·∫øt n·ªëi
            updateConnectionStatus();
            
            console.log('‚úÖ Dashboard ƒë√£ kh·ªüi t·∫°o');
        }
        
        // ========== ƒê·ªíNG B·ªò DASHBOARD ==========
        async function syncDashboard() {
            try {
                const response = await fetch('/get_sensor_data');
                const data = await response.json();
                
                if (data.success) {
                    // C·∫≠p nh·∫≠t d·ªØ li·ªáu c·∫£m bi·∫øn
                    updateSensorDisplays(data.sensors);
                    
                    // C·∫≠p nh·∫≠t bi·ªÉu ƒë·ªì
                    updateCharts(data);
                    
                    // C·∫≠p nh·∫≠t ƒë√°nh gi√°
                    updateEvaluation(data.evaluation);
                    
                    // C·∫≠p nh·∫≠t tr·∫°ng th√°i thi·∫øt b·ªã
                    updateDeviceStatus(data.sensors);
                    
                    // C·∫≠p nh·∫≠t tr·∫°ng th√°i k·∫øt n·ªëi
                    updateConnectionDetails(data.cache);
                    
                    // C·∫≠p nh·∫≠t th·ªùi gian
                    lastUpdateTime = Date.now();
                    document.getElementById('last-update-time').textContent = 
                        data.sensors.timestamp || '--:--:--';
                }
            } catch (error) {
                console.error('‚ùå L·ªói ƒë·ªìng b·ªô:', error);
                updateConnectionStatus('error');
            }
        }
        
        // ========== C·∫¨P NH·∫¨T D·ªÆ LI·ªÜU ƒê·∫¶Y ƒê·ª¶ ==========
        async function updateDashboard() {
            try {
                const response = await fetch('/get_sensor_data');
                const data = await response.json();
                
                if (data.sensors) {
                    // C·∫≠p nh·∫≠t c√†i ƒë·∫∑t
                    if (data.settings) {
                        isAutoMode = data.settings.auto_mode;
                        updateAutoModeUI(isAutoMode);
                        updateControlButtonsState(!isAutoMode);
                    }
                    
                    // C·∫≠p nh·∫≠t l·ªãch s·ª≠ bi·ªÉu ƒë·ªì
                    if (data.history) {
                        updateChartHistory(data.history);
                    }
                }
            } catch (error) {
                console.error('‚ùå L·ªói c·∫≠p nh·∫≠t dashboard:', error);
            }
        }
        
        // ========== C·∫¨P NH·∫¨T TR·∫†NG TH√ÅI K·∫æT N·ªêI ==========
        function updateConnectionDetails(cache) {
            if (!cache) return;
            
            const statusDot = document.querySelector('.status-dot');
            const syncStatus = document.getElementById('sync-status');
            const deviceStatus = document.getElementById('device-status');
            
            if (cache.status === 'connected') {
                statusDot.className = 'status-dot status-online';
                syncStatus.textContent = 'ƒêang ho·∫°t ƒë·ªông';
                deviceStatus.textContent = 'ƒêang k·∫øt n·ªëi ESP32';
            } else if (cache.status === 'idle') {
                statusDot.className = 'status-dot status-idle';
                syncStatus.textContent = 'Ch·ªù k·∫øt n·ªëi';
                deviceStatus.textContent = 'ESP32 kh√¥ng ph·∫£n h·ªìi';
            } else {
                statusDot.className = 'status-dot status-offline';
                syncStatus.textContent = 'M·∫•t k·∫øt n·ªëi';
                deviceStatus.textContent = 'S·ª≠ d·ª•ng d·ªØ li·ªáu demo';
            }
            
            // C·∫≠p nh·∫≠t th·ªùi gian
            const age = Math.floor(cache.last_update);
            const now = Math.floor(Date.now() / 1000);
            const diff = now - age;
            
            if (diff < 5) {
                syncStatus.textContent = 'ƒêang ho·∫°t ƒë·ªông (v√†i gi√¢y tr∆∞·ªõc)';
            } else if (diff < 60) {
                syncStatus.textContent = `ƒêang ho·∫°t ƒë·ªông (${diff} gi√¢y tr∆∞·ªõc)`;
            } else {
                const minutes = Math.floor(diff / 60);
                syncStatus.textContent = `ƒêang ho·∫°t ƒë·ªông (${minutes} ph√∫t tr∆∞·ªõc)`;
            }
        }
        
        function updateConnectionStatus(status = 'connected') {
            const connectionAlert = document.getElementById('connection-status');
            
            if (status === 'connected') {
                connectionAlert.className = 'alert alert-info d-flex align-items-center justify-content-between mb-3';
            } else if (status === 'error') {
                connectionAlert.className = 'alert alert-warning d-flex align-items-center justify-content-between mb-3';
            } else {
                connectionAlert.className = 'alert alert-danger d-flex align-items-center justify-content-between mb-3';
            }
        }
        
        // ========== C·∫¨P NH·∫¨T CH·∫æ ƒê·ªò T·ª∞ ƒê·ªòNG ==========
        function updateAutoModeUI(enabled) {
            const statusElement = document.getElementById('auto-mode-status');
            const noticeElement = document.getElementById('control-notice');
            
            if (statusElement) {
                statusElement.textContent = enabled ? 'ƒêANG B·∫¨T' : 'ƒêANG T·∫ÆT';
                statusElement.className = `badge ${enabled ? 'bg-success' : 'bg-secondary'} p-2`;
            }
            
            if (noticeElement) {
                if (enabled) {
                    noticeElement.innerHTML = `
                        <i class="fas fa-robot me-2 fs-4"></i>
                        <div>
                            <strong>Ch·∫ø ƒë·ªô t·ª± ƒë·ªông ƒëang b·∫≠t</strong>
                            <div class="small">H·ªá th·ªëng t·ª± ƒë·ªông ƒëi·ªÅu ch·ªânh thi·∫øt b·ªã (tr·ª´ c·∫£nh b√°o)</div>
                        </div>
                    `;
                    noticeElement.className = 'alert alert-warning d-flex align-items-center mb-3';
                } else {
                    noticeElement.innerHTML = `
                        <i class="fas fa-check-circle text-success me-2 fs-4"></i>
                        <div>
                            <strong>Ch·∫ø ƒë·ªô th·ªß c√¥ng ƒëang b·∫≠t</strong>
                            <div class="small">B·∫°n c√≥ th·ªÉ ƒëi·ªÅu khi·ªÉn thi·∫øt b·ªã th·ªß c√¥ng</div>
                        </div>
                    `;
                    noticeElement.className = 'alert alert-success d-flex align-items-center mb-3';
                }
            }
        }
        
        // ========== C·∫¨P NH·∫¨T N√öT ƒêI·ªÄU KHI·ªÇN ==========
        function updateControlButtonsState(enabled) {
            const controlButtons = document.querySelectorAll('.control-btn');
            
            controlButtons.forEach(btn => {
                const device = btn.dataset.device;
                
                // C·∫¢NH B√ÅO LU√îN ƒê∆Ø·ª¢C ƒêI·ªÄU KHI·ªÇN
                if (device === 'canh_bao') {
                    btn.disabled = false;
                    btn.style.opacity = '1';
                    btn.style.cursor = 'pointer';
                } else {
                    // C√°c thi·∫øt b·ªã kh√°c ph·ª• thu·ªôc v√†o ch·∫ø ƒë·ªô
                    if (enabled) {
                        btn.disabled = false;
                        btn.style.opacity = '1';
                        btn.style.cursor = 'pointer';
                    } else {
                        btn.disabled = true;
                        btn.style.opacity = '0.5';
                        btn.style.cursor = 'not-allowed';
                    }
                }
            });
        }
        
        // ========== G·ª¨I L·ªÜNH ƒê·∫æN ESP32 ==========
        async function sendCommandToESP32(device, action) {
            try {
                const commandMap = {
                    'quat': { 'B·∫¨T': 'FAN_ON', 'T·∫ÆT': 'FAN_OFF' },
                    'den': { 'B·∫¨T': 'LIGHT_ON', 'T·∫ÆT': 'LIGHT_OFF' },
                    'cua_so': { 'M·ªû': 'WINDOW_OPEN', 'ƒê√ìNG': 'WINDOW_CLOSE' },
                    'canh_bao': { 'B·∫¨T': 'ALARM_ON', 'T·∫ÆT': 'ALARM_OFF' }
                };
                
                if (device in commandMap && action in commandMap[device]) {
                    const command = commandMap[device][action];
                    
                    const response = await fetch('/api/esp32/command', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            device_id: 'ESP32-S3-CLASSGUARD',
                            command: command,
                            value: '1'
                        })
                    });
                    
                    const result = await response.json();
                    if (result.success) {
                        console.log(`‚úÖ ƒê√£ g·ª≠i l·ªánh ƒë·∫øn ESP32: ${command}`);
                    }
                }
            } catch (error) {
                console.error('‚ùå L·ªói g·ª≠i l·ªánh ESP32:', error);
            }
        }
        
        // ========== X·ª¨ L√ù S·ª∞ KI·ªÜN ==========
        function initEventListeners() {
            // N√∫t ƒëi·ªÅu khi·ªÉn thi·∫øt b·ªã
            document.querySelectorAll('.control-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const device = this.dataset.device;
                    const action = this.dataset.action;
                    
                    console.log(`üéÆ ƒêi·ªÅu khi·ªÉn: ${device} -> ${action}`);
                    
                    if (device && action) {
                        // Ki·ªÉm tra ch·∫ø ƒë·ªô t·ª± ƒë·ªông (tr·ª´ c·∫£nh b√°o)
                        if (device !== 'canh_bao' && isAutoMode) {
                            showToast('‚ö†Ô∏è C·∫£nh b√°o', 
                                'H·ªá th·ªëng ƒëang ·ªü ch·∫ø ƒë·ªô t·ª± ƒë·ªông. T·∫Øt ch·∫ø ƒë·ªô t·ª± ƒë·ªông ƒë·ªÉ ƒëi·ªÅu khi·ªÉn th·ªß c√¥ng.', 
                                'warning');
                            return;
                        }
                        
                        // G·ª≠i l·ªánh ƒë·∫øn server
                        controlDevice(device, action);
                        
                        // G·ª≠i l·ªánh ƒë·∫øn ESP32
                        sendCommandToESP32(device, action);
                    }
                });
            });
            
            // Chuy·ªÉn ƒë·ªïi bi·ªÉu ƒë·ªì
            const chartToggle = document.getElementById('chartToggle');
            if (chartToggle) {
                chartToggle.addEventListener('change', function() {
                    console.log('üìà Chuy·ªÉn bi·ªÉu ƒë·ªì:', this.checked);
                    updateChartVisibility(this.checked);
                });
            }
            
            // Ch·∫ø ƒë·ªô t·ª± ƒë·ªông (c·∫£ 2 toggle)
            const autoModeToggle = document.getElementById('autoModeToggle');
            const autoModeToggle2 = document.getElementById('autoModeToggle2');
            
            if (autoModeToggle) {
                autoModeToggle.addEventListener('change', async function() {
                    console.log('ü§ñ Thay ƒë·ªïi ch·∫ø ƒë·ªô t·ª± ƒë·ªông:', this.checked);
                    await updateAutoMode(this.checked);
                    if (autoModeToggle2) autoModeToggle2.checked = this.checked;
                });
            }
            
            if (autoModeToggle2) {
                autoModeToggle2.addEventListener('change', async function() {
                    console.log('ü§ñ Thay ƒë·ªïi ch·∫ø ƒë·ªô t·ª± ƒë·ªông (2):', this.checked);
                    await updateAutoMode(this.checked);
                    if (autoModeToggle) autoModeToggle.checked = this.checked;
                });
            }
            
            // Hi·ªáu ·ª©ng hover cho sensor cards
            document.querySelectorAll('.sensor-card').forEach(card => {
                card.addEventListener('mouseenter', function() {
                    this.style.transform = 'translateY(-8px)';
                    this.style.boxShadow = '0 15px 30px rgba(0, 0, 0, 0.15)';
                });
                
                card.addEventListener('mouseleave', function() {
                    this.style.transform = 'translateY(-5px)';
                    this.style.boxShadow = '0 8px 25px rgba(0, 0, 0, 0.12)';
                });
            });
        }
        
        // ========== C·∫¨P NH·∫¨T CH·∫æ ƒê·ªò T·ª∞ ƒê·ªòNG ==========
        async function updateAutoMode(enabled) {
            console.log(`ü§ñ C·∫≠p nh·∫≠t ch·∫ø ƒë·ªô t·ª± ƒë·ªông: ${enabled}`);
            
            try {
                const response = await fetch('/update_settings', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        auto_mode: enabled
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    isAutoMode = enabled;
                    updateAutoModeUI(enabled);
                    updateControlButtonsState(!enabled);
                    
                    // Th√¥ng b√°o
                    showToast('‚úÖ Th√†nh c√¥ng', 
                        `Ch·∫ø ƒë·ªô t·ª± ƒë·ªông ƒë√£ ${enabled ? 'b·∫≠t' : 't·∫Øt'}`, 
                        'success');
                } else {
                    // Rollback toggle
                    const toggle1 = document.getElementById('autoModeToggle');
                    const toggle2 = document.getElementById('autoModeToggle2');
                    if (toggle1) toggle1.checked = !enabled;
                    if (toggle2) toggle2.checked = !enabled;
                    
                    showToast('‚ùå L·ªói', 
                        result.error || 'Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t ch·∫ø ƒë·ªô t·ª± ƒë·ªông', 
                        'danger');
                }
            } catch (error) {
                console.error('‚ùå L·ªói c·∫≠p nh·∫≠t ch·∫ø ƒë·ªô t·ª± ƒë·ªông:', error);
                
                // Rollback toggle
                const toggle1 = document.getElementById('autoModeToggle');
                const toggle2 = document.getElementById('autoModeToggle2');
                if (toggle1) toggle1.checked = !enabled;
                if (toggle2) toggle2.checked = !enabled;
                
                showToast('‚ùå L·ªói', 
                    'Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn server', 
                    'danger');
            }
        }
        
        // ========== HI·ªÇN TH·ªä TOAST ==========
        function showToast(title, message, type) {
            // T·∫°o toast element
            const toastId = 'toast-' + Date.now();
            const toastHtml = `
                <div id="${toastId}" class="toast align-items-center text-white bg-${type} border-0" role="alert">
                    <div class="d-flex">
                        <div class="toast-body">
                            <strong>${title}</strong><br>
                            <small>${message}</small>
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                    </div>
                </div>
            `;
            
            // Th√™m v√†o DOM
            const container = document.createElement('div');
            container.className = 'toast-container position-fixed bottom-0 end-0 p-3';
            container.innerHTML = toastHtml;
            document.body.appendChild(container);
            
            // Hi·ªÉn th·ªã toast
            const toastElement = document.getElementById(toastId);
            const toast = new bootstrap.Toast(toastElement, {
                delay: 3000
            });
            toast.show();
            
            // X√≥a sau khi ·∫©n
            toastElement.addEventListener('hidden.bs.toast', function() {
                container.remove();
            });
        }
        
        // ========== C·∫¨P NH·∫¨T TH·ªúI GIAN ==========
        function updateRealTime() {
            const now = new Date();
            const timeElement = document.getElementById('current-time');
            if (timeElement) {
                timeElement.textContent = now.toLocaleTimeString('vi-VN');
            }
        }
        
        // ========== X·ª¨ L√ù KHI TRANG LOAD XONG ==========
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üì± Dashboard ƒë√£ t·∫£i xong');
            
            // Kh·ªüi t·∫°o dashboard
            initDashboard();
            
            // C·∫≠p nh·∫≠t score circle class
            const scoreElement = document.getElementById('score-value');
            if (scoreElement) {
                const scoreClass = '{{ evaluation.overall_class }}';
                if (scoreClass === 'success') {
                    scoreElement.className = 'overall-score score-success';
                } else if (scoreClass === 'warning') {
                    scoreElement.className = 'overall-score score-warning';
                } else {
                    scoreElement.className = 'overall-score score-danger';
                }
            }
            
            // Ki·ªÉm tra v√† x·ª≠ l√Ω responsive
            handleResponsive();
            
            // Th√™m s·ª± ki·ªán resize
            window.addEventListener('resize', handleResponsive);
        });
        
        // ========== X·ª¨ L√ù RESPONSIVE ==========
        function handleResponsive() {
            const width = window.innerWidth;
            const sensorGrid = document.querySelector('.sensor-grid');
            
            if (width < 768) {
                // Mobile: 1 c·ªôt
                if (sensorGrid) {
                    sensorGrid.style.gridTemplateColumns = '1fr';
                }
            } else if (width < 992) {
                // Tablet: 2 c·ªôt
                if (sensorGrid) {
                    sensorGrid.style.gridTemplateColumns = 'repeat(2, 1fr)';
                }
            } else {
                // Desktop: auto-fit
                if (sensorGrid) {
                    sensorGrid.style.gridTemplateColumns = 'repeat(auto-fit, minmax(220px, 1fr))';
                }
            }
        }
        
        // ========== CLEANUP KHI UNLOAD ==========
        window.addEventListener('beforeunload', function() {
            if (syncInterval) clearInterval(syncInterval);
            if (updateInterval) clearInterval(updateInterval);
            console.log('üßπ ƒê√£ d·ªçn d·∫πp intervals');
        });
    </script>
</body>
</html>
